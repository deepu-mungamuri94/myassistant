<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>My Assistant - Smart Credit Card Advisor</title>
    
    <!-- Tailwind CSS via CDN - loaded synchronously for reliability -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Capacitor Core (for native features) -->
    <script type="module">
        import { Capacitor } from 'https://cdn.jsdelivr.net/npm/@capacitor/core@latest/dist/index.js';
        import { StatusBar } from 'https://cdn.jsdelivr.net/npm/@capacitor/status-bar@latest/dist/index.js';
        import { CapacitorHttp } from 'https://cdn.jsdelivr.net/npm/@capacitor/core@latest/dist/index.js';
        // Preserve existing native plugins and add web-specific ones
        const existingPlugins = window.Capacitor?.Plugins || {};
        window.Capacitor = { ...Capacitor, Plugins: { ...existingPlugins, StatusBar, CapacitorHttp } };
        console.log('ðŸ”Œ Capacitor initialized with plugins:', Object.keys(window.Capacitor.Plugins));
    </script>
</head>
<body class="flex flex-col items-center overflow-x-hidden" style="background-color: #F5FEFD; max-width: 100vw;">
    
    <!-- SPLASH SCREEN -->
    <div id="splash-screen" class="fixed inset-0 z-[1000] flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600">
        <div class="text-center">
            <svg class="w-32 h-32 mx-auto mb-4 animate-pulse" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="splashGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.95" />
                        <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.85" />
                    </linearGradient>
                </defs>
                
                <!-- Background Circle -->
                <circle cx="50" cy="50" r="45" fill="url(#splashGrad)"/>
                
                <!-- Robot with Headphones (same as menu) -->
                <g transform="translate(50, 50)">
                    <!-- Neck -->
                    <rect x="-4" y="15" width="8" height="5" rx="1" fill="#818cf8"/>
                    
                    <!-- Shoulders -->
                    <ellipse cx="0" cy="26" rx="20" ry="10" fill="#818cf8" opacity="0.9"/>
                    
                    <!-- Head/Face (Round) -->
                    <ellipse cx="0" cy="0" rx="14" ry="16" fill="#818cf8"/>
                    
                    <!-- Antenna -->
                    <rect x="-3" y="-16" width="6" height="3" fill="#f0f0f0"/>
                    <circle cx="0" cy="-22" r="1.5" fill="#4CAF50"/>
                    
                    <!-- Headphone Band -->
                    <path d="M -14 -8 Q -14 -18, 0 -20 Q 14 -18, 14 -8" 
                          stroke="#4f46e5" 
                          stroke-width="2.5" 
                          fill="none" 
                          stroke-linecap="round"/>
                    
                    <!-- Left Ear Cup -->
                    <g transform="translate(-17, 0)">
                        <ellipse cx="0" cy="0" rx="5" ry="7" fill="#4f46e5"/>
                        <ellipse cx="0" cy="0" rx="3.5" ry="5" fill="#6366f1"/>
                        <ellipse cx="0" cy="0" rx="2" ry="3" fill="#818cf8"/>
                    </g>
                    
                    <!-- Right Ear Cup -->
                    <g transform="translate(17, 0)">
                        <ellipse cx="0" cy="0" rx="5" ry="7" fill="#4f46e5"/>
                        <ellipse cx="0" cy="0" rx="3.5" ry="5" fill="#6366f1"/>
                        <ellipse cx="0" cy="0" rx="2" ry="3" fill="#818cf8"/>
                    </g>
                    
                    <!-- Robot Eyes -->
                    <ellipse cx="-5" cy="-2" rx="3.5" ry="4.5" fill="#4f46e5"/>
                    <ellipse cx="-5" cy="-2" rx="2" ry="2.5" fill="#3730a3"/>
                    <circle cx="-6" cy="-3" r="1" fill="#ffffff"/>
                    
                    <ellipse cx="5" cy="-2" rx="3.5" ry="4.5" fill="#4f46e5"/>
                    <ellipse cx="5" cy="-2" rx="2" ry="2.5" fill="#3730a3"/>
                    <circle cx="4" cy="-3" r="1" fill="#ffffff"/>
                    
                    <!-- Robot Smile -->
                    <path d="M -6 6 Q 0 10 6 6" stroke="#4f46e5" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    
                    <!-- Microphone -->
                    <path d="M 17 5 L 22 8" stroke="#4f46e5" stroke-width="1.2" stroke-linecap="round"/>
                    <circle cx="23" cy="9" r="2" fill="#4f46e5"/>
                    
                    <!-- Chest Panel -->
                    <rect x="-5" y="16" width="10" height="2" fill="#f8f9ff"/>
                    <circle cx="-3" cy="17" r="0.5" fill="#4f46e5"/>
                    <circle cx="0" cy="17" r="0.5" fill="#4CAF50"/>
                    <circle cx="3" cy="17" r="0.5" fill="#4f46e5"/>
                </g>
            </svg>
            <h1 class="text-3xl font-bold text-white mb-2">My Assistant</h1>
            <p class="text-white/80 text-sm">Loading your personal assistant...</p>
        </div>
    </div>
    
    <!-- GLOBAL LOADING OVERLAY -->
    <div id="loading-overlay" class="hidden fixed inset-0 z-[999] bg-gray-900/40 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-6 flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
            <p id="loading-text" class="text-gray-700 font-semibold">Processing...</p>
        </div>
    </div>
    
    <!-- HEADER -->
    <header class="fixed top-0 left-0 right-0 z-40 w-full py-4 px-4 flex items-center justify-between bg-gradient-to-r from-blue-600 to-cyan-600 shadow-lg" style="padding-top: max(1rem, env(safe-area-inset-top))">
        <div class="flex items-center">
            <!-- Menu Button -->
            <button onclick="Navigation.openMenu()" class="p-2 text-white hover:bg-white/20 rounded-lg transition-all duration-200" title="Menu">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
            
            <!-- Current Page Indicator -->
            <div id="header-page-title" class="flex items-center ml-2">
                <!-- Default: Dashboard -->
                <svg class="w-6 h-6 text-white mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                </svg>
                <h1 class="text-lg font-bold text-white">Dashboard</h1>
            </div>
        </div>
        
        <!-- Settings Button with Dropdown -->
        <div class="relative">
            <button id="settings-menu-btn" onclick="Navigation.toggleSettingsMenu(event)" class="p-2 text-white hover:bg-white/20 rounded-lg transition-all duration-200">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
            </button>
            
            <!-- Settings Dropdown Menu -->
            <div id="settings-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-2xl border-2 border-gray-100 overflow-hidden z-50">
                <div class="py-2">
                    <!-- Settings -->
                    <button onclick="Navigation.openSettings(); Navigation.closeSettingsMenu();" class="w-full flex items-center px-4 py-2.5 text-left text-gray-700 hover:bg-gradient-to-r hover:from-indigo-500 hover:to-purple-500 hover:text-white transition-all">
                        <svg class="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                        </svg>
                        <span class="font-medium text-sm">Settings</span>
                    </button>
                    
                    <!-- AI Provider -->
                    <button onclick="Navigation.openAISettings(); Navigation.closeSettingsMenu();" class="w-full flex items-center px-4 py-2.5 text-left text-gray-700 hover:bg-gradient-to-r hover:from-pink-500 hover:to-rose-500 hover:text-white transition-all">
                        <svg class="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                        </svg>
                        <span class="font-medium text-sm">AI Provider</span>
                    </button>
                    
                    <div class="border-t border-gray-100 my-1"></div>
                    
                    <!-- Export Data -->
                    <button onclick="Navigation.openExportModal(); Navigation.closeSettingsMenu();" class="w-full flex items-center px-4 py-2.5 text-left text-gray-700 hover:bg-gradient-to-r hover:from-gray-600 hover:to-gray-700 hover:text-white transition-all">
                        <svg class="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                        </svg>
                        <span class="font-medium text-sm">Export Data</span>
                    </button>
                    
                    <!-- Import Data -->
                    <button onclick="Navigation.openImportModal(); Navigation.closeSettingsMenu();" class="w-full flex items-center px-4 py-2.5 text-left text-gray-700 hover:bg-gradient-to-r hover:from-gray-600 hover:to-gray-700 hover:text-white transition-all">
                        <svg class="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="font-medium text-sm">Import Data</span>
                    </button>
                    
                    <div class="border-t border-gray-100 my-1"></div>
                    
                    <!-- Reset App -->
                    <button onclick="Navigation.openResetModal(); Navigation.closeSettingsMenu();" class="w-full flex items-center px-4 py-2.5 text-left text-gray-700 hover:bg-gradient-to-r hover:from-red-600 hover:to-red-700 hover:text-white transition-all">
                        <svg class="w-4 h-4 mr-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span class="font-medium text-sm">Reset App</span>
                    </button>
                </div>
            </div>
        </div>
    </header>
    
    <!-- SIDE MENU -->
    <div id="side-menu" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-[10000]" onclick="Navigation.closeMenu()">
        <div class="bg-gradient-to-br from-white to-purple-50 w-72 h-full shadow-2xl overflow-y-auto" onclick="event.stopPropagation()">
            <div class="menu-header p-2.5 bg-gradient-to-r from-purple-600 to-pink-600">
                <div class="flex items-center mb-0.5">
                    <svg class="w-8 h-8 flex-shrink-0 mr-1.5" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="menuIconGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        
                        <!-- Background Circle -->
                        <circle cx="50" cy="50" r="45" fill="url(#menuIconGrad)"/>
                        
                        <!-- Robot with Headphones -->
                        <g transform="translate(50, 50)">
                            <!-- Neck -->
                            <rect x="-4" y="15" width="8" height="5" rx="1" fill="#ffffff"/>
                            
                            <!-- Shoulders -->
                            <ellipse cx="0" cy="26" rx="20" ry="10" fill="#ffffff" opacity="0.9"/>
                            
                            <!-- Head/Face (Round) -->
                            <ellipse cx="0" cy="0" rx="14" ry="16" fill="#ffffff"/>
                            
                            <!-- Antenna -->
                            <rect x="-3" y="-16" width="6" height="3" fill="#f0f0f0"/>
                            <circle cx="0" cy="-22" r="1.5" fill="#4CAF50"/>
                            
                            <!-- Headphone Band -->
                            <path d="M -14 -8 Q -14 -18, 0 -20 Q 14 -18, 14 -8" 
                                  stroke="#ffffff" 
                                  stroke-width="2.5" 
                                  fill="none" 
                                  stroke-linecap="round"/>
                            
                            <!-- Left Ear Cup -->
                            <g transform="translate(-17, 0)">
                                <ellipse cx="0" cy="0" rx="5" ry="7" fill="#ffffff"/>
                                <ellipse cx="0" cy="0" rx="3.5" ry="5" fill="#e0e7ff"/>
                                <ellipse cx="0" cy="0" rx="2" ry="3" fill="#c7d2fe"/>
                            </g>
                            
                            <!-- Right Ear Cup -->
                            <g transform="translate(17, 0)">
                                <ellipse cx="0" cy="0" rx="5" ry="7" fill="#ffffff"/>
                                <ellipse cx="0" cy="0" rx="3.5" ry="5" fill="#e0e7ff"/>
                                <ellipse cx="0" cy="0" rx="2" ry="3" fill="#c7d2fe"/>
                            </g>
                            
                            <!-- Robot Eyes -->
                            <ellipse cx="-5" cy="-2" rx="3.5" ry="4.5" fill="#667eea"/>
                            <ellipse cx="-5" cy="-2" rx="2" ry="2.5" fill="#4f46e5"/>
                            <circle cx="-6" cy="-3" r="1" fill="#ffffff"/>
                            
                            <ellipse cx="5" cy="-2" rx="3.5" ry="4.5" fill="#667eea"/>
                            <ellipse cx="5" cy="-2" rx="2" ry="2.5" fill="#4f46e5"/>
                            <circle cx="4" cy="-3" r="1" fill="#ffffff"/>
                            
                            <!-- Robot Smile -->
                            <path d="M -6 6 Q 0 10 6 6" stroke="#667eea" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                            
                            <!-- Microphone -->
                            <path d="M 17 5 L 22 8" stroke="#ffffff" stroke-width="1.2" stroke-linecap="round"/>
                            <circle cx="23" cy="9" r="2" fill="#ffffff"/>
                            
                            <!-- Chest Panel -->
                            <rect x="-5" y="16" width="10" height="2" fill="#f8f9ff"/>
                            <circle cx="-3" cy="17" r="0.5" fill="#667eea"/>
                            <circle cx="0" cy="17" r="0.5" fill="#4CAF50"/>
                            <circle cx="3" cy="17" r="0.5" fill="#667eea"/>
                        </g>
                    </svg>
                    <div>
                        <h2 class="text-lg font-bold text-white drop-shadow-md">My Assistant</h2>
                        <p class="text-[10px] text-purple-100">Smart Financial Advisor</p>
                    </div>
                </div>
            </div>
            
            <nav class="p-3 space-y-2">
                <!-- Dashboard -->
                <button onclick="Navigation.navigateTo('dashboard'); Navigation.closeMenu();" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-cyan-500 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-blue-400 to-cyan-400 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <svg class="w-4 h-4 text-white group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">Dashboard</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">Overview & insights</p>
                    </div>
                </button>
                
                <!-- AI Advisor -->
                <button onclick="Navigation.navigateTo('chat'); Navigation.closeMenu();" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-purple-500 hover:to-pink-500 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-purple-400 to-pink-400 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <svg class="w-4 h-4 text-white group-hover:text-purple-500 transition-colors" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"/>
                            <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">AI Advisor</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">Smart recommendations</p>
                    </div>
                </button>
                
                <!-- Section Header -->
                <div class="pt-2 pb-0.5">
                    <div class="flex items-center px-2">
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
                        <p class="text-[8px] text-gray-500 font-semibold uppercase px-2 tracking-wide">Financial</p>
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
                    </div>
                </div>
                
                <!-- Income -->
                <button onclick="Navigation.navigateTo('income')" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-green-500 hover:to-emerald-500 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-green-400 to-emerald-400 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <span class="text-xl font-bold text-white group-hover:text-green-500 transition-colors">â‚¹</span>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">Income</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">Salary & earnings</p>
                    </div>
                </button>
                
                <!-- Expenses -->
                <button onclick="Navigation.navigateTo('expenses')" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-purple-500 hover:to-pink-500 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-purple-400 to-pink-400 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <svg class="w-4 h-4 text-white group-hover:text-purple-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">Expenses</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">Track spending</p>
                    </div>
                </button>
                
                <!-- Recurring Payments -->
                <button onclick="Navigation.navigateTo('recurring')" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-orange-500 hover:to-amber-500 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-orange-400 to-amber-400 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <svg class="w-4 h-4 text-white group-hover:text-orange-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">Recurring Payments</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">Auto expenses</p>
                    </div>
                </button>
                
                <!-- Loans -->
                <button onclick="Navigation.navigateTo('loans')" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-indigo-500 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-blue-400 to-indigo-400 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <svg class="w-4 h-4 text-white group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">Loans</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">EMI tracker</p>
                    </div>
                </button>
                
                <!-- Cards Manager -->
                <button onclick="Navigation.navigateTo('cards')" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-slate-600 hover:to-blue-600 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-slate-600 to-blue-600 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <svg class="w-4 h-4 text-white group-hover:text-slate-600 transition-colors" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                            <path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">Cards Manager</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">Credit & debit cards</p>
                    </div>
                </button>
                
                <!-- Investments -->
                <button onclick="Navigation.navigateTo('investments')" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-yellow-500 hover:to-orange-500 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-400 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <svg class="w-4 h-4 text-white group-hover:text-yellow-500 transition-colors" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">Investments</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">Portfolio tracker</p>
                    </div>
                </button>
                
                <!-- Section Header -->
                <div class="pt-2 pb-0.5">
                    <div class="flex items-center px-2">
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
                        <p class="text-[8px] text-gray-500 font-semibold uppercase px-2 tracking-wide">Security</p>
                        <div class="flex-1 h-px bg-gradient-to-r from-transparent via-gray-300 to-transparent"></div>
                    </div>
                </div>
                
                <!-- Credentials -->
                <button onclick="Navigation.navigateTo('credentials')" class="group w-full flex items-center p-3 text-left text-gray-700 bg-white hover:bg-gradient-to-r hover:from-blue-500 hover:to-cyan-500 hover:text-white rounded-2xl transition-all duration-300 hover:shadow-xl transform hover:scale-105 hover:-translate-y-0.5 border border-gray-100 hover:border-transparent">
                    <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-blue-400 to-cyan-400 group-hover:from-white group-hover:to-white flex items-center justify-center mr-2 transition-all duration-300 shadow-md">
                        <svg class="w-4 h-4 text-white group-hover:text-blue-500 transition-colors" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <span class="font-bold text-sm">Credentials</span>
                        <p class="text-[11px] opacity-70 group-hover:opacity-90">Secure passwords</p>
                    </div>
                </button>
                
            </nav>
        </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div class="w-full overflow-x-hidden" style="margin-top: calc(3.5rem + env(safe-area-inset-top)); padding-bottom: env(safe-area-inset-bottom);">
        
        <!-- DASHBOARD VIEW -->
        <div id="dashboard-view" class="p-4 min-h-screen max-w-full overflow-x-hidden">
            <!-- Dashboard Content -->
            <div id="dashboard-content" class="max-w-full overflow-x-hidden">
                <!-- Charts will be rendered here -->
            </div>
        </div>
        
        <!-- AI ADVISOR VIEW -->
        <div id="chat-view" class="hidden">
            <div class="flex flex-col" style="min-height: calc(100vh - 3.5rem - env(safe-area-inset-top));">
                <!-- Context Selector Bar -->
                <div class="bg-purple-50 border-b-2 border-purple-200 p-3 shadow-sm">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium text-purple-800">Context:</span>
                            <select id="chat-mode" onchange="Chat.updateWelcomeMessage(); Chat.clear();" class="px-3 py-1.5 bg-white text-purple-700 rounded-lg text-sm font-semibold border-2 border-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                                <option value="cards">ðŸ’³ Cards</option>
                                <option value="general">ðŸ’¬ General</option>
                                <option value="expenses">ðŸ“Š Expenses</option>
                                <option value="investments">ðŸ’° Investments</option>
                            </select>
                        </div>
                        <button onclick="Chat.clear()" class="px-2 py-1 bg-white hover:bg-purple-100 text-purple-700 rounded-lg transition-all duration-200 text-xs font-medium flex items-center gap-1 border-2 border-purple-300" title="Clear chat">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                            </svg>
                            Clear
                        </button>
                    </div>
                </div>
                
                <!-- Chat Messages (Scrollable) -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 pb-32">
                    <div class="text-center text-gray-500 text-sm px-4 py-8">
                        <p class="text-base mb-3">ðŸ’³ <strong>AI Credit Card Advisor</strong></p>
                        <p class="mb-2 text-sm">I'll help you choose the best credit card for your spending!</p>
                        <p class="text-xs mb-3 text-gray-400">I search online for current card benefits and offers from bank websites.</p>
                        
                        <div class="bg-blue-50 p-3 rounded-lg text-left mb-3 max-w-md mx-auto">
                            <p class="text-xs font-semibold text-blue-800 mb-2">ðŸ’¡ Try asking:</p>
                            <ul class="text-xs space-y-1 text-blue-700">
                                <li>â€¢ "â‚¹5000 on groceries at BigBasket"</li>
                                <li>â€¢ "â‚¹10,000 for flight tickets"</li>
                                <li>â€¢ "â‚¹2000 for dining at restaurants"</li>
                                <li>â€¢ "â‚¹15,000 for online shopping"</li>
                            </ul>
                        </div>
                        
                        <p class="text-xs text-gray-400 mt-2">
                            ðŸ”’ Secure: Only card names are shared, never numbers or CVV
                        </p>
                    </div>
                </div>
                
                <!-- Chat Input (Fixed at bottom) -->
                <div class="fixed bottom-0 left-0 right-0 border-t border-gray-300 p-3" style="z-index: 9999; background-color: #F5FEFD;">
                    <div class="flex gap-2">
                        <textarea id="chat-input" placeholder="Ask me anything..." class="flex-1 p-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none bg-white" rows="2" onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); Chat.send(); }"></textarea>
                        <button onclick="Chat.send()" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 flex items-center justify-center" title="Send">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 2L11 13M22 2L15 22L11 13M22 2L2 8L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- INCOME VIEW -->
        <div id="income-view" class="hidden">
            <div class="p-5 pb-6">
                <!-- Floating Edit Button (Top Right) -->
                <button onclick="if(window.Income) window.Income.openForm()" class="fixed right-4 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:shadow-xl transition-all z-30 hover:scale-110" style="top: calc(3.5rem + env(safe-area-inset-top) + 1rem);" title="Edit Income">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                    </svg>
                </button>
                
                <!-- Income Content -->
                <div id="income-content">
                    <!-- Income details will be rendered here -->
                </div>
            </div>
        </div>
        
        <!-- EXPENSES VIEW -->
        <div id="expenses-view" class="hidden">
            <div class="p-5 pb-32">
                <!-- Floating + Button (Top Right) -->
                <button onclick="openExpenseModal()" class="fixed right-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:shadow-xl transition-all z-30 hover:scale-110" style="top: calc(3.5rem + env(safe-area-inset-top) + 1rem);" title="Add Expense">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                </button>
                
                <!-- Total Expenses Info Section -->
                <div id="expenses-summary" class="mb-4 p-4 rounded-xl" style="background: linear-gradient(135deg, rgba(167, 139, 250, 0.15) 0%, rgba(236, 72, 153, 0.15) 50%, rgba(251, 207, 232, 0.15) 100%); box-shadow: 0 8px 32px 0 rgba(147, 51, 234, 0.1), inset 0 1px 1px rgba(255, 255, 255, 0.5); backdrop-filter: blur(8px); border: 2px solid rgba(167, 139, 250, 0.3); border-radius: 12px;">
                    <!-- Total Amount -->
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-bold text-purple-900 text-lg">Total Expenses</h3>
                        <span id="expenses-total-amount" class="font-bold text-purple-900 text-xl">â‚¹0</span>
                    </div>
                    <!-- Transaction Count and Date Range with Loan Info -->
                    <p id="expenses-transaction-info" class="text-sm text-purple-700 mb-1">0 transactions</p>
                    <div class="flex justify-between items-center mb-2">
                        <p id="expenses-date-range" class="text-sm text-purple-700">-</p>
                        <!-- Loan EMI Info (if included) -->
                        <p id="expenses-loan-info" class="text-xs text-purple-600 hidden">+ <span id="loan-emi-amount">â‚¹0</span> loans</p>
                    </div>
                    <!-- Filter Info and Loan Toggle -->
                    <div class="flex justify-between items-center">
                        <p class="text-xs text-purple-600">Filter: <span id="date-filter-label-info" class="font-medium text-purple-800">Current Month</span></p>
                        <!-- Toggle Switch for Loans -->
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-purple-700 font-medium">ðŸ’° Loans</span>
                            <button id="toggle-loans-btn" onclick="if(!this.disabled && window.Expenses) Expenses.toggleLoansInTotal()" class="relative inline-flex items-center h-5 w-9 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-1 bg-gray-300" title="Exclude Loans - Click to Include">
                                <span id="toggle-loans-slider" class="inline-block w-4 h-4 transform rounded-full bg-white shadow-lg transition-transform translate-x-0.5"></span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Expenses List -->
                <div id="expenses-list" class="space-y-3">
                    <!-- Expenses will be listed here -->
                </div>
            </div>
            
            <!-- Fixed Bottom Bar (Search and Filter) -->
            <div class="fixed bottom-0 left-0 right-0 border-t border-gray-300 p-3" style="z-index: 9999; background-color: #F5FEFD;">
                <div class="flex gap-2">
                    <input type="text" id="expenses-search" placeholder="ðŸ” Search expenses..." class="flex-1 p-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white" oninput="if(window.Expenses) searchExpenses()">
                    <button id="expense-filter-btn" onclick="if(window.Expenses) openDateFilterModal()" class="px-4 py-3 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-lg transition-all duration-200 border-2 border-purple-300" title="Filter by date">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- RECURRING PAYMENTS VIEW -->
        <div id="recurring-view" class="hidden">
            <div class="p-5 pb-6">
                <!-- Floating + Button (Top Right) -->
                <button onclick="openRecurringExpenseModal()" class="fixed right-4 bg-gradient-to-r from-orange-600 to-amber-600 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:shadow-xl transition-all z-30 hover:scale-110" style="top: calc(3.5rem + env(safe-area-inset-top) + 1rem);" title="Add Recurring Payment">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                </button>
                
                <!-- Recurring Expenses List -->
                <div id="recurring-expenses-list" class="space-y-3">
                    <!-- Recurring expenses will be listed here -->
                </div>
            </div>
        </div>
        
        <!-- LOANS VIEW -->
        <div id="loans-view" class="hidden">
            <div class="p-5 pb-6">
                <!-- Floating + Button (Top Right) - Orange Color -->
                <button onclick="openLoanModal()" class="fixed right-4 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:shadow-xl transition-all z-30 hover:scale-110" style="top: calc(3.5rem + env(safe-area-inset-top) + 1rem);" title="Add Loan">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                </button>
                
                <!-- Loans List -->
                <div id="loans-list" class="space-y-3">
                    <!-- Loans will be listed here -->
                </div>
            </div>
        </div>
        
        <!-- CARDS VIEW -->
        <div id="cards-view" class="hidden">
            <div class="p-5 pb-24">
                <!-- Search Box -->
                <div class="mb-4">
                    <input type="text" id="cards-search" placeholder="ðŸ” Search cards..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" oninput="searchCards()">
                </div>
                
                <!-- Cards List -->
                <div id="cards-list" class="space-y-3">
                    <!-- Cards will be listed here -->
                </div>
            </div>
            
            <!-- Fixed Bottom Bar -->
            <div class="fixed bottom-0 left-0 right-0 border-t border-gray-300 p-3" style="z-index: 9999; background-color: #F5FEFD;">
                <div class="flex gap-2 items-center" style="max-width: 100%; overflow: hidden;">
                    <button id="credit-tab" onclick="Cards.switchTab('credit')" class="flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gradient-to-r from-slate-600 to-blue-600 text-white shadow-md" style="flex-shrink: 0;">
                        ðŸ’³ Credit
                    </button>
                    <button id="debit-tab" onclick="Cards.switchTab('debit')" class="flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gray-200 text-gray-700 hover:bg-gray-300" style="flex-shrink: 0;">
                        ðŸ’¸ Debit
                    </button>
                    <button onclick="openCardModal()" class="py-3 px-3 bg-gradient-to-r from-slate-600 to-blue-600 text-white rounded-lg hover:shadow-lg transition-all font-medium text-sm flex items-center" style="flex-shrink: 0;">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- INVESTMENTS VIEW -->
        <div id="investments-view" class="hidden">
            <div class="p-5 pb-32">
                <!-- Floating + Button (Top Right) -->
                <button onclick="Investments.openInvestmentModal()" class="fixed right-4 bg-gradient-to-br from-green-500 via-emerald-600 to-green-700 text-white rounded-full w-12 h-12 flex items-center justify-center shadow-lg hover:shadow-xl transition-all z-30 hover:scale-110" style="top: calc(3.5rem + env(safe-area-inset-top) + 1rem);" title="Add Investment">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                </button>
                
                <!-- Portfolio Section -->
                <div id="investments-portfolio-section" class="mb-6">
                    <!-- Will be rendered by Investments.render() -->
                </div>
                
                <!-- Monthly Investments Section -->
                <div id="investments-monthly-section">
                    <!-- Will be rendered by Investments.render() -->
                </div>
            </div>
            
            <!-- Fixed Bottom Bar (Search & Date Filter) -->
            <div class="fixed bottom-0 left-0 right-0 border-t border-gray-300 p-3 flex gap-2" style="z-index: 9999; background-color: #F5FEFD;">
                <input type="text" id="investments-search" placeholder="ðŸ” Search investments..." class="flex-1 p-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 bg-white" oninput="Investments.handleSearch(this.value)">
                <button onclick="Investments.openDateFilterModal()" class="px-4 py-3 bg-yellow-200 hover:bg-yellow-300 text-yellow-800 rounded-lg transition-all duration-200 border-2 border-yellow-400" title="Filter by date">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- CREDENTIALS VIEW -->
        <div id="credentials-view" class="hidden">
            <div class="p-4 pb-32">
                <!-- Floating + Button (Top Right) -->
                <button onclick="openCredentialModal()" class="fixed right-4 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:shadow-xl transition-all z-30 hover:scale-110" style="top: calc(3.5rem + env(safe-area-inset-top) + 1rem);" title="Add Credential">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                </button>
                
                <!-- Main Credentials Section -->
                <div class="bg-white rounded-2xl shadow-md border border-gray-200 overflow-hidden">
                    <!-- Section Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-cyan-600 px-4 py-3">
                        <div class="flex items-center justify-between">
                            <span id="credentials-count" class="text-white text-sm font-semibold">0 credentials</span>
                            <button id="toggle-credentials-groups-btn" onclick="Credentials.toggleAllGroups()" class="px-3 py-1.5 bg-white/20 hover:bg-white/30 backdrop-blur-sm text-white rounded-lg transition-all text-xs font-semibold">
                                ðŸ“‚ Expand All
                            </button>
                        </div>
                    </div>
                    
                    <!-- Section Body -->
                    <div id="credentials-list" class="p-3 space-y-2">
                        <!-- Credentials grouped by tag will be listed here -->
                    </div>
                </div>
            </div>
            
            <!-- Fixed Bottom Bar (Search) -->
            <div class="fixed bottom-0 left-0 right-0 border-t border-gray-300 p-3" style="z-index: 9999; background-color: #F5FEFD;">
                <input type="text" id="credentials-search" placeholder="ðŸ” Search credentials..." class="w-full p-3 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" oninput="searchCredentials()">
            </div>
        </div>
        
    </div>
    
    <!-- AI SETTINGS MODAL -->
    <div id="ai-settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Navigation.closeAISettings()">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200">
                <h2 class="text-2xl font-bold bg-gradient-to-r from-pink-600 to-rose-600 bg-clip-text text-transparent flex items-center gap-2">
                    <svg class="w-6 h-6 text-pink-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                    </svg>
                    AI Provider Settings
                </h2>
            </div>
            
            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-6 space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">AI Provider</label>
                    <select id="ai-provider" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="gemini">Google Gemini</option>
                        <option value="groq">Groq (Mixtral)</option>
                        <option value="chatgpt">OpenAI ChatGPT</option>
                        <option value="perplexity">Perplexity AI</option>
                    </select>
                </div>
                
                <!-- Priority Order Section -->
                <div class="border-t pt-4 mt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        Fallback Priority Order
                        <span class="text-xs font-normal text-gray-500 block mt-1">Define which AI to use first, and fallbacks if rate limit is reached</span>
                    </label>
                    <div class="space-y-2" id="priority-order-list">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Gemini API Key</label>
                    <div class="relative">
                        <input type="password" id="gemini-api-key" placeholder="Enter your Gemini API key" class="w-full p-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button type="button" onclick="togglePasswordVisibility('gemini-api-key')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="gemini-api-key-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-purple-600 underline">Google AI Studio</a></p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Groq API Key</label>
                    <div class="relative">
                        <input type="password" id="groq-api-key" placeholder="Enter your Groq API key" class="w-full p-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button type="button" onclick="togglePasswordVisibility('groq-api-key')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="groq-api-key-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://console.groq.com/keys" target="_blank" class="text-purple-600 underline">Groq Console</a> (Free tier: 30 req/min)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ChatGPT API Key</label>
                    <div class="relative">
                        <input type="password" id="chatgpt-api-key" placeholder="Enter your ChatGPT API key" class="w-full p-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button type="button" onclick="togglePasswordVisibility('chatgpt-api-key')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="chatgpt-api-key-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-purple-600 underline">OpenAI Platform</a></p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Perplexity API Key</label>
                    <div class="relative">
                        <input type="password" id="perplexity-api-key" placeholder="Enter your Perplexity API key" class="w-full p-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <button type="button" onclick="togglePasswordVisibility('perplexity-api-key')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="perplexity-api-key-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Get your API key from <a href="https://www.perplexity.ai/settings/api" target="_blank" class="text-purple-600 underline">Perplexity Settings</a></p>
                </div>
            </div>
            
            <!-- Fixed Footer Buttons -->
            <div class="p-6 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
                <div class="flex space-x-3">
                    <button onclick="Navigation.saveAISettings()" class="flex-1 px-4 py-2 bg-gradient-to-r from-pink-600 to-rose-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                        Save
                    </button>
                    <button onclick="Navigation.closeAISettings()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Navigation.closeSettings()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent flex items-center gap-2">
                <svg class="w-6 h-6 text-indigo-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                </svg>
                Settings
            </h2>
            
            <div class="space-y-4">
                <!-- Security Section -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-3">
                        ðŸ”’ Security
                        <span class="text-xs font-normal text-gray-500 block mt-1">Manage your PIN and data encryption</span>
                    </label>
                    <button onclick="openChangePinModal()" class="w-full px-4 py-3 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold flex items-center justify-center gap-2 mb-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                        </svg>
                        Change PIN
                    </button>
                    
                    <!-- Biometric Toggle -->
                    <label id="biometric-settings-toggle" class="hidden flex items-center p-3 bg-purple-50 border border-purple-200 rounded-lg cursor-pointer hover:bg-purple-100 transition-colors">
                        <input type="checkbox" id="biometric-enabled-checkbox" class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="ml-3 flex-1">
                            <span class="text-sm font-semibold text-purple-900">Enable Fingerprint/Face ID</span>
                            <span class="block text-xs text-purple-600">Quick unlock with biometric authentication</span>
                        </span>
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
                        </svg>
                    </label>
                </div>
                
                <!-- Master Password Section -->
                <div class="border-t pt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        ðŸ” Master Password (for Export/Import)
                        <span class="text-xs font-normal text-gray-500 block mt-1">
                            This password encrypts your exported data with AES-256 encryption
                        </span>
                    </label>
                    <div class="relative">
                        <input type="password" id="master-password" placeholder="Enter master password" 
                               class="w-full p-3 pr-12 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                        <button type="button" onclick="togglePasswordVisibility('master-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="master-password-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-amber-600 mt-2 flex items-start gap-1">
                        <svg class="w-4 h-4 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        <span>Store this password safely! Without it, you cannot decrypt your backups.</span>
                    </p>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button onclick="Navigation.saveSettings()" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                        Save
                    </button>
                    <button onclick="Navigation.closeSettings()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- INVESTMENT ADD/EDIT MODAL -->
    <div id="investment-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Investments.closeInvestmentModal()">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="p-6 pb-4">
                <h2 id="investment-modal-title" class="text-2xl font-bold bg-gradient-to-r from-yellow-600 to-orange-600 bg-clip-text text-transparent">Add Investment</h2>
            </div>
            
            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto px-6">
                <input type="hidden" id="investment-id">
                <input type="hidden" id="investment-is-monthly">
                <input type="hidden" id="investment-editing">
                
                <!-- Goal Selection (Short Term & Long Term) -->
                <div id="goal-field" class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Goal</label>
                    <div class="flex gap-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="investment-goal" value="SHORT_TERM" class="w-4 h-4 text-yellow-600 focus:ring-yellow-500" onchange="Investments.validateNameDuplicate()">
                            <span class="ml-2 text-sm font-medium text-gray-700">Short Term</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="investment-goal" value="LONG_TERM" checked class="w-4 h-4 text-yellow-600 focus:ring-yellow-500" onchange="Investments.validateNameDuplicate()">
                            <span class="ml-2 text-sm font-medium text-gray-700">Long Term</span>
                        </label>
                    </div>
                </div>
                
                <!-- Type Selection -->
                <div class="mb-3">
                    <label class="block text-sm font-semibold text-gray-700 mb-1">Type</label>
                    <select id="investment-type" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500" onchange="Investments.handleTypeChange()">
                        <option value="">Select Type</option>
                        <option value="SHARES">Shares</option>
                        <option value="GOLD">Gold</option>
                        <option value="EPF">EPF</option>
                        <option value="FD">Fixed Deposit</option>
                    </select>
                </div>
                
                <!-- Dynamic Fields Container -->
                <div id="investment-dynamic-fields">
                    <!-- Fields will be dynamically added here based on type -->
                </div>
            </div>
            
            <!-- Fixed Bottom Buttons -->
            <div class="p-6 pt-4 border-t border-gray-200 bg-white rounded-b-2xl">
                <div class="flex gap-3">
                    <button id="investment-save-btn" onclick="Investments.saveInvestment()" disabled class="flex-1 px-4 py-2 bg-gray-300 text-gray-500 rounded-lg font-semibold cursor-not-allowed">
                        Update
                    </button>
                    <button onclick="Investments.closeInvestmentModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- INVESTMENT DATE FILTER MODAL -->
    <div id="investment-date-filter-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Investments.closeDateFilterModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-yellow-600 to-orange-600 bg-clip-text text-transparent">Filter Monthly Investments</h2>
            
            <!-- Filter Options -->
            <div class="space-y-3 mb-4">
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                    <input type="radio" name="investment-date-filter" value="thisMonth" checked class="w-4 h-4 text-yellow-600" onchange="Investments.handleDateFilterChange()">
                    <span class="ml-3 text-sm font-medium text-gray-700">This Month</span>
                </label>
                
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                    <input type="radio" name="investment-date-filter" value="last6Months" class="w-4 h-4 text-yellow-600" onchange="Investments.handleDateFilterChange()">
                    <span class="ml-3 text-sm font-medium text-gray-700">Last 6 Months</span>
                </label>
                
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                    <input type="radio" name="investment-date-filter" value="thisYear" class="w-4 h-4 text-yellow-600" onchange="Investments.handleDateFilterChange()">
                    <span class="ml-3 text-sm font-medium text-gray-700">This Year</span>
                </label>
                
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                    <input type="radio" name="investment-date-filter" value="custom" class="w-4 h-4 text-yellow-600" onchange="Investments.handleDateFilterChange()">
                    <span class="ml-3 text-sm font-medium text-gray-700">Custom Range</span>
                </label>
                
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-lg cursor-pointer hover:bg-gray-50 transition-all">
                    <input type="radio" name="investment-date-filter" value="allTime" class="w-4 h-4 text-yellow-600" onchange="Investments.handleDateFilterChange()">
                    <span class="ml-3 text-sm font-medium text-gray-700">All Time</span>
                </label>
            </div>
            
            <!-- Custom Date Range Fields -->
            <div id="investment-custom-date-fields" class="hidden space-y-3 mb-4 p-3 bg-gray-50 rounded-lg">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">From Date</label>
                    <input type="date" id="investment-filter-start-date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-1">To Date</label>
                    <input type="date" id="investment-filter-end-date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
            </div>
            
            <div id="investment-filter-buttons" class="hidden flex space-x-3">
                <button onclick="Investments.applyDateFilter()" class="flex-1 px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Apply Filter
                </button>
                <button onclick="Investments.closeDateFilterModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- EXPENSE MODAL -->
    <div id="expense-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeExpenseModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 id="expense-modal-title-header" class="text-2xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Add Expense</h2>
            
            <input type="hidden" id="expense-modal-id">
            
            <!-- Title Input with Autocomplete -->
            <div class="relative mb-3">
                <input type="text" id="expense-modal-title" placeholder="Title (e.g., Grocery Shopping) *" 
                       class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                       oninput="showExpenseSuggestions(this.value); clearFieldError('expense-modal-title')"
                       onfocus="showExpenseSuggestions(this.value)"
                       autocomplete="off">
                <div id="expense-suggestions" class="hidden absolute w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto z-10 mt-1"></div>
                <div id="expense-modal-title-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">â‚¹</span>
                    <input type="number" id="expense-modal-amount" placeholder="Amount (e.g., 100)" step="0.01" class="w-full p-2 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" oninput="clearFieldError('expense-modal-amount')">
                </div>
                <div id="expense-modal-amount-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <select id="expense-modal-category" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="clearFieldError('expense-modal-category')">
                    <option value="">Select Category *</option>
                    <option value="Food & Dining">Food & Dining</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Transportation">Transportation</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Bills & Utilities">Bills & Utilities</option>
                    <option value="Healthcare">Healthcare</option>
                    <option value="Travel">Travel</option>
                    <option value="Education">Education</option>
                    <option value="Groceries">Groceries</option>
                    <option value="emi">EMI</option>
                    <option value="recurring">Recurring</option>
                    <option value="Other">Other</option>
                </select>
                <div id="expense-modal-category-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <input type="date" id="expense-modal-date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="clearFieldError('expense-modal-date')">
                <div id="expense-modal-date-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <textarea id="expense-modal-description" placeholder="Description (optional - additional details)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" rows="2"></textarea>
            
            <div class="flex space-x-3">
                <button id="expense-modal-save-btn" onclick="saveExpenseModal()" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Add
                </button>
                <button onclick="closeExpenseModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- INCOME MODAL -->
    <div id="income-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Income.closeForm()">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="p-6 pb-4">
                <h2 class="text-2xl font-bold bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">Income Details</h2>
            </div>
            
            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto px-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Annual CTC *</label>
                <div class="relative mb-3">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">â‚¹</span>
                    <input type="text" id="income-ctc" placeholder="24,00,000" class="w-full p-2 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" oninput="formatIndianCurrency(this); Income.updateBasicPreview()">
                </div>
                
                <div class="bg-green-50 p-3 rounded-lg mb-3 border border-green-200">
                    <p class="text-xs text-green-700 mb-1">Total Basic (40% of CTC)</p>
                    <p id="basic-preview" class="text-lg font-bold text-green-800">â‚¹0</p>
                </div>
                
                <!-- Bonus and PF on same line -->
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bonus</label>
                        <div class="relative">
                            <input type="number" id="income-bonus-percent" placeholder="e.g., 20" step="0.1" class="w-full p-2 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">PF</label>
                        <div class="relative">
                            <input type="number" id="income-pf-percent" placeholder="12" step="0.1" value="12" class="w-full p-2 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">%</span>
                        </div>
                    </div>
                </div>
                
                <label class="block text-sm font-medium text-gray-700 mb-1">ESPP (Two Cycles)</label>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Dec-May</label>
                        <div class="relative">
                            <input type="number" id="income-espp-cycle1" placeholder="e.g., 10" step="0.1" class="w-full p-2 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">%</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Jun-Nov</label>
                        <div class="relative">
                            <input type="number" id="income-espp-cycle2" placeholder="e.g., 10" step="0.1" class="w-full p-2 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Health Insurance Premium (Optional) -->
                <div class="mb-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                    <label class="flex items-center gap-2 mb-2">
                        <input type="checkbox" id="income-has-insurance" onchange="Income.toggleInsuranceFields()" class="w-4 h-4 text-purple-600">
                        <span class="text-sm font-medium text-purple-900">Include Health Insurance Premium</span>
                    </label>
                    <div id="insurance-fields" class="hidden space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Total Premium</label>
                                <div class="relative">
                                    <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 text-xs pointer-events-none">â‚¹</span>
                                    <input type="text" id="income-insurance-total" placeholder="15,000" class="w-full p-2 pl-6 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" oninput="formatIndianCurrency(this)">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Split Months</label>
                                <input type="number" id="income-insurance-months" placeholder="e.g., 3" min="1" max="12" class="w-full p-2 text-sm border border-purple-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" oninput="Income.updateInsuranceMonths()">
                            </div>
                        </div>
                        <div id="insurance-months-checkboxes" class="grid grid-cols-3 gap-2 text-xs">
                            <!-- Month checkboxes will be generated here -->
                        </div>
                        <div id="insurance-per-month" class="text-xs text-purple-700"></div>
                    </div>
                </div>
                
                <!-- Leave Encashment (January) -->
                <div class="mb-4 p-3 bg-cyan-50 rounded-lg border border-cyan-200">
                    <label class="block text-sm font-medium text-cyan-900 mb-1">Leave Encashment (January)</label>
                    <input type="number" id="income-leave-days" placeholder="Days to cash out (optional)" step="0.5" min="0" class="w-full p-2 mb-2 text-sm border border-cyan-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500">
                    <label class="block text-xs text-cyan-700 mb-1">Override Allowances (optional)</label>
                    <div class="relative">
                        <span class="absolute left-2 top-1/2 -translate-y-1/2 text-gray-500 text-xs pointer-events-none">â‚¹</span>
                        <input type="text" id="income-leave-allowances-override" placeholder="Leave blank to use calculated" class="w-full p-2 pl-6 text-sm border border-cyan-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-cyan-500" oninput="formatIndianCurrency(this)">
                    </div>
                    <p class="text-xs text-cyan-600 mt-1">Formula: Days Ã— (Basic + HRA + Allowances) / 27</p>
                    <p class="text-xs text-cyan-500 mt-0.5">Default uses payslip allowances. Override if company uses different amount.</p>
                </div>
            </div>
            
            <!-- Fixed Bottom Buttons -->
            <div class="p-6 pt-4 border-t border-gray-200 bg-white rounded-b-2xl">
                <div class="flex gap-2">
                    <button onclick="Income.saveForm()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                        Save
                    </button>
                    <button onclick="Income.closeForm()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TAX SLABS MODAL -->
    <div id="tax-slabs-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Income.closeTaxSlabsModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent">Manage Tax Slabs</h2>
            
            <p class="text-sm text-gray-600 mb-4 bg-orange-50 p-3 rounded-lg border border-orange-200">
                Configure income tax slabs according to your country's tax regime
            </p>
            
            <!-- Tax Slabs List -->
            <div id="tax-slabs-list" class="space-y-2 mb-4">
                <!-- Slabs will be rendered here -->
            </div>
            
            <!-- Actions -->
            <div class="flex gap-2">
                <button onclick="Income.addTaxSlab()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                    + Add Slab
                </button>
                <button onclick="Income.resetToDefaultSlabs()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200 font-semibold">
                    Reset
                </button>
                <button onclick="Income.closeTaxSlabsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- TAX SLAB EDIT MODAL -->
    <div id="slab-edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Income.closeSlabEditModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 id="slab-edit-title" class="text-xl font-bold mb-4 bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent">Add Tax Slab</h2>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Label (e.g., "â‚¹4L - â‚¹8L")</label>
                    <input type="text" id="slab-edit-label" placeholder="Label" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Minimum Amount (â‚¹)</label>
                    <input type="number" id="slab-edit-min" placeholder="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maximum Amount (â‚¹) - Leave empty for unlimited</label>
                    <input type="number" id="slab-edit-max" placeholder="Leave empty for Infinity" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tax Rate (%)</label>
                    <input type="number" id="slab-edit-rate" placeholder="0" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button onclick="Income.saveSlab()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                    Save
                </button>
                <button onclick="Income.closeSlabEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- STD DEDUCTION MODAL -->
    <div id="std-deduction-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Income.closeStdDeductionModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-4 bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent">Edit Standard Deduction</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Standard Deduction Amount (â‚¹)</label>
                <input type="number" id="std-deduction-input" placeholder="75000" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                <p class="text-xs text-gray-500 mt-1">Standard deduction is subtracted from your CTC before calculating tax</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="Income.saveStdDeduction()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                    Save
                </button>
                <button onclick="Income.closeStdDeductionModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- DEDUCTIONS MANAGEMENT MODAL -->
    <div id="deductions-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Income.closeDeductionsModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4 bg-gradient-to-r from-green-600 to-emerald-600 bg-clip-text text-transparent">Manage Tax Deductions</h2>
            
            <p class="text-xs text-gray-600 mb-4 bg-green-50 p-3 rounded-lg border border-green-200">
                Configure all tax deductions to calculate accurate taxable income. Note: In New Tax Regime, most deductions (80C, 80D, HRA) are not allowed.
            </p>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Standard Deduction (â‚¹)</label>
                    <input type="number" id="deductions-std" placeholder="75000" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <p class="text-xs text-gray-500 mt-1">Default: â‚¹75,000 (Allowed in New Tax Regime)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">HRA Exemption (â‚¹)</label>
                    <input type="number" id="deductions-hra" placeholder="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <p class="text-xs text-gray-500 mt-1">House Rent Allowance exemption (Old Tax Regime only)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Section 80C (â‚¹)</label>
                    <input type="number" id="deductions-80c" placeholder="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <p class="text-xs text-gray-500 mt-1">Investments, PF, PPF, ELSS, etc. Max: â‚¹1.5L (Old Tax Regime only)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Section 80D (â‚¹)</label>
                    <input type="number" id="deductions-80d" placeholder="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <p class="text-xs text-gray-500 mt-1">Health Insurance premiums (Old Tax Regime only)</p>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Other Deductions (â‚¹)</label>
                    <input type="number" id="deductions-other" placeholder="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                    <p class="text-xs text-gray-500 mt-1">Any other applicable deductions</p>
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button onclick="Income.saveDeductions()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                    Save
                </button>
                <button onclick="Income.closeDeductionsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- CESS MODAL -->
    <div id="cess-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Income.closeCessModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-4 bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent">Edit Cess Percentage</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Cess Percentage (%)</label>
                <input type="number" id="cess-percent-input" placeholder="e.g., 4" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                <p class="text-xs text-gray-500 mt-1">Cess is calculated on (Base Tax + Surcharge)</p>
            </div>
            
            <div class="flex gap-2">
                <button onclick="Income.saveCessPercent()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                    Save
                </button>
                <button onclick="Income.closeCessModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- SURCHARGE SLABS MODAL -->
    <div id="surcharge-slabs-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Income.closeSurchargeSlabsModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent">Manage Surcharge Slabs</h2>
            
            <p class="text-sm text-gray-600 mb-4 bg-orange-50 p-3 rounded-lg border border-orange-200">
                Configure surcharge brackets based on your tax regime. The active bracket for your CTC is highlighted.
            </p>
            
            <!-- Surcharge Slabs List -->
            <div id="surcharge-slabs-list" class="space-y-2 mb-4">
                <!-- Slabs will be rendered here -->
            </div>
            
            <!-- Actions -->
            <div class="flex gap-2">
                <button onclick="Income.addSurchargeSlab()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                    + Add Slab
                </button>
                <button onclick="Income.resetSurchargeSlabs()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all duration-200 font-semibold">
                    Reset
                </button>
                <button onclick="Income.closeSurchargeSlabsModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- SURCHARGE EDIT MODAL -->
    <div id="surcharge-edit-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Income.closeSurchargeEditModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 id="surcharge-edit-title" class="text-xl font-bold mb-4 bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent">Add Surcharge Slab</h2>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Label (e.g., "â‚¹50L - â‚¹1 Cr")</label>
                    <input type="text" id="surcharge-edit-label" placeholder="Label" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Minimum Amount (â‚¹)</label>
                    <input type="number" id="surcharge-edit-min" placeholder="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Maximum Amount (â‚¹) - Leave empty for unlimited</label>
                    <input type="number" id="surcharge-edit-max" placeholder="Leave empty for Infinity" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Surcharge Rate (%)</label>
                    <input type="number" id="surcharge-edit-rate" placeholder="0" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
            </div>
            
            <div class="flex gap-2 mt-6">
                <button onclick="Income.saveSurchargeSlab()" class="flex-1 px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                    Save
                </button>
                <button onclick="Income.closeSurchargeEditModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- RECURRING EXPENSE MODAL -->
    <div id="recurring-expense-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeRecurringExpenseModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 id="recurring-modal-title" class="text-2xl font-bold mb-4 bg-gradient-to-r from-orange-600 to-amber-600 bg-clip-text text-transparent">Add Recurring Payment</h2>
            
            <input type="hidden" id="recurring-modal-id">
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Name *</label>
                <input type="text" id="recurring-modal-name" placeholder="e.g., LIC Premium, Car Insurance" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" oninput="clearFieldError('recurring-modal-name')">
                <div id="recurring-modal-name-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Amount *</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">â‚¹</span>
                    <input type="number" id="recurring-modal-amount" placeholder="Amount (e.g., 1000)" step="0.01" class="w-full p-2 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" oninput="clearFieldError('recurring-modal-amount')">
                </div>
                <div id="recurring-modal-amount-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Frequency *</label>
                <select id="recurring-modal-frequency" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" onchange="updateRecurringFrequency(); clearFieldError('recurring-modal-frequency')">
                    <option value="">Select Frequency</option>
                    <option value="monthly">Monthly (Every Month)</option>
                    <option value="yearly">Yearly (One Specific Month)</option>
                    <option value="custom">Custom (Multiple Months)</option>
                </select>
                <div id="recurring-modal-frequency-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Day of Month *</label>
                <input type="number" id="recurring-modal-day" placeholder="Day (1-31)" min="1" max="31" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" oninput="clearFieldError('recurring-modal-day')">
                <div id="recurring-modal-day-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <label class="block text-sm font-medium text-gray-700 mb-1">End Date (Optional)</label>
            <div class="flex items-center gap-2 mb-3">
                <input type="month" id="recurring-modal-end-date" class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
                <label class="flex items-center text-sm text-gray-600">
                    <input type="checkbox" id="recurring-modal-indefinite" class="mr-2" onchange="toggleEndDate()">
                    Indefinite
                </label>
            </div>
            
            <div id="recurring-months-section" class="hidden mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Months *</label>
                <div class="grid grid-cols-3 gap-2">
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="1" onchange="clearFieldError('recurring-modal-months')"> Jan
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="2" onchange="clearFieldError('recurring-modal-months')"> Feb
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="3" onchange="clearFieldError('recurring-modal-months')"> Mar
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="4" onchange="clearFieldError('recurring-modal-months')"> Apr
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="5" onchange="clearFieldError('recurring-modal-months')"> May
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="6" onchange="clearFieldError('recurring-modal-months')"> Jun
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="7" onchange="clearFieldError('recurring-modal-months')"> Jul
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="8" onchange="clearFieldError('recurring-modal-months')"> Aug
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="9" onchange="clearFieldError('recurring-modal-months')"> Sep
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="10" onchange="clearFieldError('recurring-modal-months')"> Oct
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="11" onchange="clearFieldError('recurring-modal-months')"> Nov
                    </label>
                    <label class="flex items-center p-2 border border-gray-300 rounded-lg cursor-pointer hover:bg-orange-50">
                        <input type="checkbox" class="mr-2" value="12" onchange="clearFieldError('recurring-modal-months')"> Dec
                    </label>
                </div>
                <div id="recurring-modal-months-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
            <textarea id="recurring-modal-description" placeholder="Additional details" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500" rows="2"></textarea>
            
            <!-- Helper Tip -->
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-20">
                <p class="text-xs text-orange-800">
                    <strong>ðŸ’¡ Tip:</strong> Recurring expenses are automatically added to your expense list on the specified day each month. You can view and manage upcoming auto-added expenses in this page.
                </p>
            </div>
            
            <!-- Fixed Bottom Buttons -->
            <div class="sticky bottom-0 left-0 right-0 bg-white border-t border-gray-200 pt-3 -mx-6 px-6 -mb-6 pb-6">
                <div class="flex space-x-3">
                    <button onclick="saveRecurringExpenseModal()" class="flex-1 px-4 py-3 bg-gradient-to-r from-orange-600 to-amber-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                        Save
                    </button>
                    <button onclick="closeRecurringExpenseModal()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- LOAN MODAL -->
    <div id="loan-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeLoanModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 id="loan-modal-title" class="text-2xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">Add Loan</h2>
            
            <input type="hidden" id="loan-modal-id">
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Bank Name *</label>
                <input type="text" id="loan-modal-bank" placeholder="e.g., HDFC Bank, SBI" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('loan-modal-bank')">
                <div id="loan-modal-bank-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Loan Type *</label>
                <select id="loan-modal-type" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleCustomLoanType(); clearFieldError('loan-modal-type')">
                    <option value="">Select Type</option>
                    <option value="Personal">Personal Loan</option>
                    <option value="Home">Home Loan</option>
                    <option value="Car">Car Loan</option>
                    <option value="Gold">Gold Loan</option>
                    <option value="Other">Other (Specify)</option>
                </select>
                <div id="loan-modal-type-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div id="custom-loan-type-section" class="hidden mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Specify Loan Type *</label>
                <input type="text" id="loan-modal-custom-type" placeholder="e.g., Education, Medical" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('loan-modal-custom-type')">
                <div id="loan-modal-custom-type-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
            <input type="text" id="loan-modal-reason" placeholder="e.g., New car purchase, House renovation" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Total Amount *</label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">â‚¹</span>
                    <input type="number" id="loan-modal-amount" placeholder="Loan Amount (e.g., 100000)" step="0.01" class="w-full p-2 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('loan-modal-amount')">
                </div>
                <div id="loan-modal-amount-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Interest Rate (per annum) *</label>
                <div class="relative">
                    <input type="number" id="loan-modal-interest" placeholder="e.g., 8.5" step="0.01" class="w-full p-2 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('loan-modal-interest')">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">%</span>
                </div>
                <div id="loan-modal-interest-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">Tenure (Months) *</label>
                <input type="number" id="loan-modal-tenure" placeholder="e.g., 60 (5 years)" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('loan-modal-tenure')">
                <div id="loan-modal-tenure-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <label class="block text-sm font-medium text-gray-700 mb-1">First EMI Date *</label>
                <input type="date" id="loan-modal-first-emi-date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="clearFieldError('loan-modal-first-emi-date')">
                <div id="loan-modal-first-emi-date-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <!-- Helper Tip -->
            <div class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-20">
                <p class="text-xs text-orange-800">
                    <strong>ðŸ’¡ Tip:</strong> EMIs are automatically added to your expenses on the specified date each month. Track your loan progress with the remaining balance and interest paid so far.
                </p>
            </div>
            
            <!-- Fixed Bottom Buttons -->
            <div class="sticky bottom-0 left-0 right-0 bg-white border-t border-gray-200 pt-3 -mx-6 px-6 -mb-6 pb-6">
                <div class="flex space-x-3">
                    <button onclick="saveLoanModal()" class="flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-amber-500 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                        Save
                    </button>
                    <button onclick="closeLoanModal()" class="flex-1 px-4 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- DATE FILTER MODAL -->
    <div id="date-filter-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeDateFilterModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">Filter by Date</h2>
            
            <div class="grid grid-cols-2 gap-3 mb-4">
                <button onclick="if(window.Expenses) applyQuickFilter('today')" class="px-4 py-3 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-lg transition-all font-semibold">
                    Today
                </button>
                <button onclick="if(window.Expenses) applyQuickFilter('week')" class="px-4 py-3 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-lg transition-all font-semibold">
                    Last 7 Days
                </button>
                <button onclick="if(window.Expenses) applyQuickFilter('month')" class="px-4 py-3 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-lg transition-all font-semibold">
                    This Month
                </button>
                <button onclick="if(window.Expenses) applyQuickFilter('year')" class="px-4 py-3 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded-lg transition-all font-semibold">
                    This Year
                </button>
            </div>
            
            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="text-sm font-semibold text-gray-700 mb-2 block">Custom Range</label>
                <div class="grid grid-cols-1 gap-2">
                    <div>
                        <label class="text-xs text-gray-600 block mb-1">Start Date</label>
                        <input type="date" id="filter-start-date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600 block mb-1">End Date</label>
                        <input type="date" id="filter-end-date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-3">
                <button onclick="applyCustomDateFilter()" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Apply
                </button>
                <button onclick="if(window.Expenses) applyQuickFilter('all')" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    All Time
                </button>
            </div>
        </div>
    </div>
    
    <!-- EXCHANGE RATE MODAL -->
    <div id="exchange-rate-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Investments.closeExchangeRateModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-yellow-600 to-orange-600 bg-clip-text text-transparent">Exchange Rate</h2>
            
            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm text-gray-600 mb-1">Current Rate</p>
                <p id="current-rate-display" class="text-2xl font-bold text-gray-800">â‚¹83.00</p>
            </div>
            
            <label class="block text-sm font-semibold text-gray-700 mb-2">New USD to INR Rate</label>
            <input type="number" id="exchange-rate-input" placeholder="Enter new rate (e.g., 83.50)" step="0.01" class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
            
            <p class="text-xs text-gray-600 mb-4">ðŸ’¡ This rate will be used to convert USD share prices to INR and will automatically recalculate all USD portfolio values</p>
            
            <div class="flex space-x-3">
                <button onclick="Investments.saveExchangeRate()" class="flex-1 px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Update
                </button>
                <button onclick="Investments.closeExchangeRateModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- GOLD RATE MODAL -->
    <div id="gold-rate-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Investments.closeGoldRateModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-yellow-600 to-orange-600 bg-clip-text text-transparent">Gold Rate per Gram</h2>
            
            <div class="mb-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <p class="text-sm text-yellow-800 mb-1">Current Rate</p>
                <p class="text-2xl font-bold text-yellow-900">â‚¹<span id="current-gold-rate-display">---</span></p>
            </div>
            
            <label class="block text-sm font-semibold text-gray-700 mb-2">New Gold Rate (â‚¹ per gram)</label>
            <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">â‚¹</span>
                <input type="number" id="gold-rate-input" placeholder="Enter rate per gram" step="0.01" class="w-full p-3 pl-8 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
            </div>
            
            <p class="text-xs text-gray-600 mb-4">ðŸª™ This rate will be used to calculate all gold investment values and will automatically recalculate all Gold portfolio values</p>
            
            <div class="flex space-x-3">
                <button onclick="Investments.saveGoldRate()" class="flex-1 px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Update
                </button>
                <button onclick="Investments.closeGoldRateModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- CUSTOM DELETE CONFIRMATION MODAL -->
    <div id="delete-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col">
            <div class="flex items-center p-6 pb-4">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-gray-900">Confirm Deletion</h2>
            </div>
            
            <div id="delete-confirm-message" class="flex-1 overflow-y-auto px-6"></div>
            
            <div class="p-6 pt-4 border-t border-gray-200 bg-white rounded-b-2xl">
                <div class="flex space-x-3">
                    <button id="delete-confirm-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 font-semibold">
                        Delete
                    </button>
                    <button id="delete-cancel-btn" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ADD OR OVERRIDE CHOICE MODAL -->
    <div id="add-override-choice-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-gray-900">Existing Entry Found</h2>
            </div>
            
            <p id="add-override-message" class="text-gray-700 mb-6"></p>
            
            <div class="space-y-3">
                <button id="add-to-existing-btn" class="w-full px-4 py-3 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                    </svg>
                    Add to Existing
                </button>
                <button id="override-existing-btn" class="w-full px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    Override Existing
                </button>
                <button id="add-override-cancel-btn" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- COMMON SUCCESS MODAL (Used across all modules) -->
    <div id="common-success-modal" class="hidden fixed inset-0 bg-white bg-opacity-60 z-[60] flex items-center justify-center">
        <div class="flex flex-col items-center">
            <!-- Animated Checkmark Circle -->
            <div class="relative">
                <svg class="w-24 h-24 animate-scale-in" viewBox="0 0 100 100">
                    <!-- Circle Border -->
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#10B981" stroke-width="4" class="animate-fade-in"/>
                    <!-- Checkmark -->
                    <path d="M30 50 L42 62 L70 34" stroke="#10B981" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" class="animate-draw-check"/>
                </svg>
            </div>
            <!-- Success Text (Customizable) -->
            <p id="success-modal-message" class="mt-4 text-lg font-bold text-green-600 animate-fade-in-up text-center leading-relaxed">Success</p>
        </div>
    </div>
    
    <!-- COMMON ERROR MODAL (Used across all modules) -->
    <div id="common-error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-scale-in relative">
            <!-- Close Button (Top Right) -->
            <button onclick="(function() { const modal = document.getElementById('common-error-modal'); Utils.hideModal('common-error-modal'); if (modal._errorCallback) { modal._errorCallback(); modal._errorCallback = null; } })()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6 flex flex-col items-center">
                <!-- Animated X Mark Circle -->
                <div class="relative mb-4">
                    <svg class="w-24 h-24" viewBox="0 0 100 100">
                        <!-- Circle Border (Red) -->
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#EF4444" stroke-width="4" class="animate-fade-in"/>
                        <!-- X Mark -->
                        <path d="M35 35 L65 65 M65 35 L35 65" stroke="#EF4444" stroke-width="6" stroke-linecap="round" class="animate-draw-x"/>
                    </svg>
                </div>
                
                <!-- Error Title -->
                <h3 class="text-xl font-bold text-red-600 mb-3 animate-fade-in-up">Error</h3>
                
                <!-- Error Message (Customizable) -->
                <p id="error-modal-message" class="text-gray-700 text-center leading-relaxed animate-fade-in-up">An error occurred</p>
                
                <!-- Close Button (Bottom) -->
                <button onclick="(function() { const modal = document.getElementById('common-error-modal'); Utils.hideModal('common-error-modal'); if (modal._errorCallback) { modal._errorCallback(); modal._errorCallback = null; } })()" class="mt-6 px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 font-semibold">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- COMMON INFO MODAL (Used across all modules for informational messages) -->
    <div id="common-info-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full animate-scale-in relative">
            <!-- Close Button (Top Right) -->
            <button onclick="(function() { const modal = document.getElementById('common-info-modal'); Utils.hideModal('common-info-modal'); if (modal._infoCallback) { modal._infoCallback(); modal._infoCallback = null; } })()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
            
            <div class="p-6 flex flex-col items-center">
                <!-- Animated Info Icon Circle -->
                <div class="relative mb-4">
                    <svg class="w-24 h-24" viewBox="0 0 100 100">
                        <!-- Circle Border (Blue) -->
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#3B82F6" stroke-width="4" class="animate-fade-in"/>
                        <!-- Info Icon (i) -->
                        <circle cx="50" cy="35" r="4" fill="#3B82F6" class="animate-fade-in"/>
                        <path d="M50 45 L50 70" stroke="#3B82F6" stroke-width="6" stroke-linecap="round" class="animate-draw-check"/>
                    </svg>
                </div>
                
                <!-- Info Title -->
                <h3 class="text-xl font-bold text-blue-600 mb-3 animate-fade-in-up">Information</h3>
                
                <!-- Info Message (Customizable) -->
                <p id="info-modal-message" class="text-gray-700 text-center leading-relaxed animate-fade-in-up">Information message</p>
                
                <!-- Close Button (Bottom) -->
                <button onclick="(function() { const modal = document.getElementById('common-info-modal'); Utils.hideModal('common-info-modal'); if (modal._infoCallback) { modal._infoCallback(); modal._infoCallback = null; } })()" class="mt-6 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all duration-200 font-semibold">
                    Got it
                </button>
            </div>
        </div>
    </div>
    
    <!-- PROGRESS MODAL (Used for showing loading status with updates) -->
    <div id="progress-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[70] flex items-center justify-center">
        <!-- Close Button (Top Right - initially hidden, fixed position) -->
        <button id="progress-modal-close-btn" onclick="Utils.closeProgressModal()" class="hidden fixed top-8 right-8 text-gray-400 hover:text-white transition-colors z-[71]">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
        
        <div class="flex flex-col items-center">
            <!-- Loading Spinner (shown during progress) -->
            <div id="progress-spinner" class="mb-4">
                <svg class="w-16 h-16 animate-spin text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
            </div>
            
            <!-- Success Icon (hidden initially) -->
            <div id="progress-success-icon" class="hidden">
                <svg class="w-24 h-24 animate-scale-in" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#10B981" stroke-width="4" class="animate-fade-in"/>
                    <path d="M30 50 L42 62 L70 34" stroke="#10B981" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" class="animate-draw-check"/>
                </svg>
            </div>
            
            <!-- Error Icon (hidden initially) -->
            <div id="progress-error-icon" class="hidden">
                <svg class="w-24 h-24" viewBox="0 0 100 100">
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#EF4444" stroke-width="4" class="animate-fade-in"/>
                    <path d="M35 35 L65 65 M65 35 L35 65" stroke="#EF4444" stroke-width="6" stroke-linecap="round" class="animate-draw-x"/>
                </svg>
            </div>
            
            <!-- Status Message -->
            <p id="progress-modal-message" class="mt-4 text-lg font-bold text-white animate-fade-in-up text-center leading-relaxed">Loading...</p>
        </div>
    </div>
    
    <!-- INVESTMENT SUCCESS MODAL (Backward compatibility - points to common modal) -->
    <div id="investment-success-modal" class="hidden fixed inset-0 bg-white bg-opacity-60 z-[60] flex items-center justify-center">
        <div class="flex flex-col items-center">
            <!-- Animated Checkmark Circle -->
            <div class="relative">
                <svg class="w-24 h-24 animate-scale-in" viewBox="0 0 100 100">
                    <!-- Circle Border -->
                    <circle cx="50" cy="50" r="45" fill="none" stroke="#10B981" stroke-width="4" class="animate-fade-in"/>
                    <!-- Checkmark -->
                    <path d="M30 50 L42 62 L70 34" stroke="#10B981" stroke-width="6" fill="none" stroke-linecap="round" stroke-linejoin="round" class="animate-draw-check"/>
                </svg>
            </div>
            <!-- Success Text -->
            <p class="mt-4 text-xl font-bold text-green-600 animate-fade-in-up">Success</p>
        </div>
    </div>
    
    <style>
        @keyframes scale-in {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fade-in {
            0% {
                opacity: 0;
            }
            100% {
                opacity: 1;
            }
        }
        
        @keyframes draw-check {
            0% {
                stroke-dasharray: 0, 100;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                stroke-dasharray: 100, 0;
                opacity: 1;
            }
        }
        
        @keyframes draw-x {
            0% {
                stroke-dasharray: 0, 100;
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                stroke-dasharray: 100, 0;
                opacity: 1;
            }
        }
        
        @keyframes fade-in-up {
            0% {
                transform: translateY(10px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .animate-scale-in {
            animation: scale-in 0.5s ease-out;
        }
        
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        
        .animate-draw-check {
            animation: draw-check 0.5s ease-out 0.2s forwards;
            stroke-dasharray: 0, 100;
        }
        
        .animate-draw-x {
            animation: draw-x 0.5s ease-out 0.2s forwards;
            stroke-dasharray: 0, 100;
        }
        
        .animate-fade-in-up {
            animation: fade-in-up 0.4s ease-out 0.4s forwards;
            opacity: 0;
        }
        
        @keyframes loading-dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }
        
        .loading-dots {
            display: inline-block;
            animation: loading-dots 1.5s infinite;
            font-weight: bold;
            color: #6b7280;
        }
        
        .loading-dots::after {
            content: '';
            animation: loading-dots-content 1.5s infinite;
        }
        
        @keyframes loading-dots-content {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }
    </style>
    
    <!-- OVERRIDE CONFIRMATION MODAL -->
    <div id="override-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-gray-900">Override Warning</h2>
            </div>
            
            <p id="override-confirm-message" class="text-gray-700 mb-6"></p>
            
            <div class="flex space-x-3">
                <button id="override-proceed-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 font-semibold">
                    Yes, Override
                </button>
                <button id="override-cancel-btn" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- SHARE PRICE MANAGEMENT MODAL -->
    <div id="share-price-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Investments.closeSharePriceModal()">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] flex flex-col">
            <!-- Header -->
            <div class="p-6 pb-4">
                <h2 class="text-2xl font-bold bg-gradient-to-r from-yellow-600 to-orange-600 bg-clip-text text-transparent">Manage Share Prices</h2>
            </div>
            
            <!-- Share Prices List (scrollable) -->
            <div id="share-prices-list" class="flex-1 overflow-y-auto px-6 space-y-3">
                <!-- Will be populated dynamically -->
            </div>
            
            <!-- Bottom Buttons (fixed) -->
            <div class="p-6 pt-4 border-t border-gray-200 bg-white rounded-b-2xl">
                <div class="flex gap-3 justify-center">
                    <button id="global-reload-btn" onclick="Investments.reloadAllSharePrices()" class="flex-1 max-w-xs px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold flex items-center justify-center gap-2">
                        <svg class="w-4 h-4 reload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>Reload prices</span>
                    </button>
                    <button onclick="Investments.closeSharePriceModal()" class="flex-1 max-w-xs px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- EDIT SHARE PRICE MODAL -->
    <div id="edit-share-price-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Investments.closeEditPriceModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-6 bg-gradient-to-r from-yellow-600 to-orange-600 bg-clip-text text-transparent">Edit Share Price</h2>
            
            <!-- Share Name : Currency Input (Single Line) -->
            <div class="mb-4">
                <div class="flex items-center gap-3">
                    <span id="edit-share-name" class="text-lg font-semibold text-gray-800"></span>
                    <span class="text-gray-500">:</span>
                    <div class="relative flex items-center">
                        <span id="edit-share-currency" class="text-lg font-semibold text-gray-700 mr-2">â‚¹</span>
                        <input 
                            type="number" 
                            id="edit-share-price-input" 
                            step="0.01" 
                            min="0.01"
                            class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-lg"
                            placeholder="0.00"
                            oninput="document.getElementById('edit-share-price-error').classList.add('hidden')">
                    </div>
                </div>
                <div id="edit-share-price-error" class="hidden text-red-500 text-xs mt-2"></div>
            </div>
            
            <!-- Buttons -->
            <div class="flex gap-3 mt-6">
                <button onclick="Investments.saveEditedSharePrice()" class="flex-1 px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                    Save
                </button>
                <button onclick="Investments.closeEditPriceModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- CREDENTIAL ADD/EDIT MODAL -->
    <div id="credential-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeCredentialModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 id="credential-modal-title" class="text-2xl font-bold mb-4 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Add Credential</h2>
            
            <input type="hidden" id="credential-modal-id">
            
            <div class="mb-3">
                <input type="text" id="credential-modal-service" placeholder="Service Name *" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" oninput="clearFieldError('credential-modal-service')">
                <div id="credential-modal-service-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <input type="text" id="credential-modal-tag" placeholder="Tag (e.g., Work, Personal, Bank)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
            
            <div class="mb-3">
                <div class="relative">
                    <input type="password" id="credential-modal-username" placeholder="Username *" class="w-full p-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" oninput="clearFieldError('credential-modal-username')">
                    <button type="button" onclick="togglePasswordVisibility('credential-modal-username')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                        <svg id="credential-modal-username-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </button>
                </div>
                <div id="credential-modal-username-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <div class="relative">
                    <input type="password" id="credential-modal-password" placeholder="Password *" class="w-full p-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" oninput="clearFieldError('credential-modal-password')">
                    <button type="button" onclick="togglePasswordVisibility('credential-modal-password')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                        <svg id="credential-modal-password-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </button>
                </div>
                <div id="credential-modal-password-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <textarea id="credential-modal-description" placeholder="Description (shown in list)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="2"></textarea>
            <textarea id="credential-modal-additional-details" placeholder="Additional Details (optional)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" rows="3"></textarea>
            
            <div class="flex space-x-3">
                <button onclick="saveCredentialModal()" class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Save
                </button>
                <button onclick="closeCredentialModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
        <!-- CREDENTIAL VIEW MODAL -->
        <div id="credential-view-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeCredentialViewModal()">
            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Credential Details</h2>
                
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-gray-500 font-semibold">Service</label>
                        <p id="view-service" class="text-base font-medium text-gray-800"></p>
                    </div>
                    <div id="view-tag-container" class="hidden">
                        <label class="text-xs text-gray-500 font-semibold">Tag</label>
                        <p id="view-tag" class="text-sm text-blue-600"></p>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-semibold">Username</label>
                        <p id="view-username" class="text-base font-medium text-gray-800"></p>
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 font-semibold">Password</label>
                        <div class="flex items-center gap-2">
                            <p id="view-password" class="text-base font-mono text-gray-800 flex-1">â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢</p>
                            <button onclick="toggleViewPassword()" class="text-indigo-600 hover:text-indigo-800">
                                <svg id="view-password-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="view-description-container" class="hidden">
                        <label class="text-xs text-gray-500 font-semibold">Description</label>
                        <p id="view-description" class="text-sm text-gray-600"></p>
                    </div>
                    <div id="view-additional-details-container" class="hidden">
                        <label class="text-xs text-gray-500 font-semibold">Additional Details</label>
                        <p id="view-additional-details" class="text-sm text-gray-600"></p>
                    </div>
            </div>
            
            <div class="mt-6">
                <button onclick="closeCredentialViewModal()" class="w-full px-4 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- CARD ADD/EDIT MODAL -->
    <div id="card-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeCardModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 id="card-modal-title" class="text-2xl font-bold mb-4 bg-gradient-to-r from-slate-600 to-blue-600 bg-clip-text text-transparent">Add Card</h2>
            
            <input type="hidden" id="card-modal-id">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Card Type</label>
            <select id="card-modal-type" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="toggleCreditOnlyFields()">
                <option value="credit">ðŸ’³ Credit Card</option>
                <option value="debit">ðŸ’¸ Debit Card</option>
            </select>
            
            <div class="mb-3">
                <input type="text" id="card-modal-name" placeholder="Card Name (e.g., HDFC Regalia) *" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('card-modal-name')">
                <div id="card-modal-name-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="mb-3">
                <input type="text" id="card-modal-number" placeholder="Card Number (16 digits) *" maxlength="19" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('card-modal-number')">
                <div id="card-modal-number-error" class="text-red-600 text-xs mt-1 hidden"></div>
            </div>
            
            <div class="flex gap-2 mb-3">
                <div class="flex-1">
                    <input type="text" id="card-modal-expiry" placeholder="MM/YY *" maxlength="5" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="formatCardExpiry(this); clearFieldError('card-modal-expiry')">
                    <div id="card-modal-expiry-error" class="text-red-600 text-xs mt-1 hidden"></div>
                </div>
                <div class="w-24">
                    <input type="text" id="card-modal-cvv" placeholder="CVV *" maxlength="4" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('card-modal-cvv')">
                    <div id="card-modal-cvv-error" class="text-red-600 text-xs mt-1 hidden"></div>
                </div>
            </div>
            
            <!-- Credit Card Only Fields -->
            <div id="credit-only-fields">
                <div class="mb-3">
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">â‚¹</span>
                        <input type="text" id="card-modal-credit-limit" placeholder="Credit Limit (e.g., 50000) - Optional" class="w-full p-2 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="clearFieldError('card-modal-credit-limit')">
                    </div>
                    <div id="card-modal-credit-limit-error" class="text-red-600 text-xs mt-1 hidden"></div>
                </div>
            </div>
            
            <textarea id="card-modal-additional-data" placeholder="Note (optional)" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="2"></textarea>
            
            <div class="flex space-x-3">
                <button onclick="saveCardModal()" class="flex-1 px-4 py-2 bg-gradient-to-r from-slate-600 to-blue-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Save
                </button>
                <button onclick="closeCardModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- EMI LIST MODAL -->
    <div id="emi-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) document.getElementById('emi-modal').classList.add('hidden')">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-2xl w-full max-h-[80vh] flex flex-col">
            <h2 id="emi-modal-title" class="text-2xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">EMIs</h2>
            
            <div id="emi-list" class="flex-1 overflow-y-auto mb-4">
                <!-- EMIs will be rendered here -->
            </div>
            
            <div class="flex space-x-3">
                <button onclick="Cards.openEMIForm(window.currentEMICardId)" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    + Add EMI
                </button>
                <button onclick="document.getElementById('emi-modal').classList.add('hidden')" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- EMI FORM MODAL -->
    <div id="emi-form-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-[60] flex items-center justify-center p-4" onclick="if(event.target===this) document.getElementById('emi-form-modal').classList.add('hidden')">
        <div class="rounded-2xl shadow-2xl p-6 max-w-md w-full backdrop-blur-lg" style="background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);">
            <h2 id="emi-form-title" class="text-2xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">Add EMI</h2>
            
            <input type="hidden" id="emi-form-id">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
            <input type="text" id="emi-form-reason" placeholder="e.g., iPhone 15 Pro" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">First EMI Date</label>
            <input type="date" id="emi-form-first-date" class="w-full p-2 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateRemainingEMIs()">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Monthly EMI Amount (optional)</label>
            <div class="relative mb-3">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm pointer-events-none">â‚¹</span>
                <input type="number" id="emi-form-amount" placeholder="5000" class="w-full p-2 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Paid EMIs</label>
                    <input type="number" id="emi-form-paid" placeholder="0" min="0" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Total EMIs</label>
                    <input type="number" id="emi-form-total" placeholder="6" min="1" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="calculateRemainingEMIs()">
                </div>
            </div>
            
            <div id="emi-auto-info" class="text-xs text-gray-600 mb-3 p-2 bg-blue-50 rounded-lg hidden">
                <!-- Auto-calculated info will show here -->
            </div>
            
            <div class="flex space-x-3">
                <button onclick="Cards.saveEMI(window.currentEMICardId)" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Save
                </button>
                <button onclick="document.getElementById('emi-form-modal').classList.add('hidden')" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- EXPORT MODAL -->
    <div id="export-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Navigation.closeExportModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-gray-600 to-gray-800 bg-clip-text text-transparent">Export Data</h2>
            <p class="text-gray-600 mb-4">Download all your data as an encrypted file for backup or device migration.</p>
            
            <button onclick="Navigation.exportData()" class="w-full px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-800 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold mb-3">
                ðŸ“¥ Download Backup File
            </button>
            
            <button onclick="Navigation.closeExportModal()" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                Cancel
            </button>
        </div>
    </div>
    
    <!-- IMPORT MODAL -->
    <div id="import-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Navigation.closeImportModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-gray-600 to-gray-800 bg-clip-text text-transparent flex items-center gap-2">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
                Import Encrypted Backup
            </h2>
            <p class="text-gray-600 mb-4">Upload your encrypted backup file (.enc) and enter your master password to restore data.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Select Backup File</label>
                    <input type="file" id="import-file" accept=".enc" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Master Password</label>
                    <div class="relative">
                        <input type="password" id="import-password" placeholder="Enter master password used during export" 
                               class="w-full p-3 pr-12 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                        <button type="button" onclick="togglePasswordVisibility('import-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="import-password-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ðŸ” This is the password you set in Settings before exporting</p>
                </div>
            </div>
            
            <button onclick="Navigation.importData()" class="w-full px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-800 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold mt-4 mb-3">
                ðŸ“¥ Decrypt & Import
            </button>
            
            <button onclick="Navigation.closeImportModal()" class="w-full px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                Cancel
            </button>
        </div>
    </div>
    
    <!-- MASTER PASSWORD SETUP MODAL (Onboarding) -->
    <div id="master-password-setup-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 z-[1001] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                    Set Master Password
                </h2>
                <p class="text-gray-600 text-sm mt-2">This password encrypts your export backups</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Master Password (min 6 characters)</label>
                    <div class="relative">
                        <input type="password" id="onboarding-master-password" placeholder="Enter master password" 
                               class="w-full px-4 py-3 pr-12 border-2 border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="button" onclick="togglePasswordVisibility('onboarding-master-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="onboarding-master-password-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Confirm Password</label>
                    <div class="relative">
                        <input type="password" id="onboarding-master-password-confirm" placeholder="Confirm master password" 
                               class="w-full px-4 py-3 pr-12 border-2 border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <button type="button" onclick="togglePasswordVisibility('onboarding-master-password-confirm')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="onboarding-master-password-confirm-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 flex gap-2">
                    <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <div class="text-xs text-amber-800">
                        <strong>Important:</strong> Remember this password! You'll need it to import backups. Without it, your backups cannot be decrypted.
                    </div>
                </div>
            </div>
            
            <button onclick="completeMasterPasswordSetup()" class="w-full mt-6 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-bold text-lg">
                Continue
            </button>
        </div>
    </div>
    
    <!-- AI KEYS SETUP MODAL (Onboarding) -->
    <div id="ai-keys-setup-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 z-[1001] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-pink-600 to-rose-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold bg-gradient-to-r from-pink-600 to-rose-600 bg-clip-text text-transparent">
                    Configure AI Providers
                </h2>
                <p class="text-gray-600 text-sm mt-2">Set up your AI API keys for smart features</p>
            </div>
            
            <div class="space-y-4">
                <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-3 mb-4">
                    <p class="text-sm text-amber-900 font-semibold mb-2">
                        âš ï¸ Gemini or Perplexity is REQUIRED
                    </p>
                    <p class="text-xs text-amber-800">
                        Card Benefits feature needs web search capability. You must provide at least ONE of: Gemini or Perplexity.<br>
                        Groq/ChatGPT are optional (for faster chat).
                    </p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Gemini API Key <span class="text-red-600">*</span></label>
                    <div class="relative">
                        <input type="password" id="onboarding-gemini-key" placeholder="Enter Gemini API key" 
                               class="w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 text-sm">
                        <button type="button" onclick="togglePasswordVisibility('onboarding-gemini-key')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="onboarding-gemini-key-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Get from <a href="https://makersuite.google.com/app/apikey" target="_blank" class="text-pink-600 underline">Google AI Studio</a></p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Groq API Key</label>
                    <div class="relative">
                        <input type="password" id="onboarding-groq-key" placeholder="Enter Groq API key" 
                               class="w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 text-sm">
                        <button type="button" onclick="togglePasswordVisibility('onboarding-groq-key')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="onboarding-groq-key-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Get from <a href="https://console.groq.com/keys" target="_blank" class="text-pink-600 underline">Groq Console</a></p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">ChatGPT API Key</label>
                    <div class="relative">
                        <input type="password" id="onboarding-chatgpt-key" placeholder="Enter ChatGPT API key" 
                               class="w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 text-sm">
                        <button type="button" onclick="togglePasswordVisibility('onboarding-chatgpt-key')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="onboarding-chatgpt-key-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Get from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-pink-600 underline">OpenAI Platform</a></p>
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Perplexity API Key <span class="text-red-600">*</span></label>
                    <div class="relative">
                        <input type="password" id="onboarding-perplexity-key" placeholder="Enter Perplexity API key" 
                               class="w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500 text-sm">
                        <button type="button" onclick="togglePasswordVisibility('onboarding-perplexity-key')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700 focus:outline-none">
                            <svg id="onboarding-perplexity-key-eye" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Get from <a href="https://www.perplexity.ai/settings/api" target="_blank" class="text-pink-600 underline">Perplexity Settings</a></p>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-800 mb-2">
                        <strong class="text-red-600">* Required:</strong> You need at least ONE of: Gemini OR Perplexity (not both)
                    </p>
                    <p class="text-xs text-blue-800">
                        ðŸ’¡ <strong>Tip:</strong> You can add more keys later in AI Settings
                    </p>
                </div>
            </div>
            
            <button onclick="completeAIKeysSetup()" class="w-full mt-6 px-6 py-3 bg-gradient-to-r from-pink-600 to-rose-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-bold text-lg">
                Start Using App
            </button>
        </div>
    </div>
    
    <!-- SECURITY SETUP MODAL -->
    <div id="security-setup-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 z-[1001] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-purple-600 to-pink-600 rounded-full mx-auto mb-4 flex items-center justify-center">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                    Secure Your App
                </h2>
                <p class="text-gray-600 text-sm mt-2">Set up PIN to protect your data</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Create PIN (4 digits)</label>
                    <input type="password" id="setup-pin" inputmode="numeric" maxlength="4" 
                           class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-2xl tracking-widest font-bold"
                           placeholder="â€¢â€¢â€¢â€¢"
                           oninput="handlePinInput('setup-pin', 'setup-pin-confirm')">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Confirm PIN</label>
                    <input type="password" id="setup-pin-confirm" inputmode="numeric" maxlength="4"
                           class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-2xl tracking-widest font-bold"
                           placeholder="â€¢â€¢â€¢â€¢"
                           oninput="handlePinConfirmInput()">
                </div>
                
                <div id="biometric-setup-option" class="hidden bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="enable-biometric-checkbox" class="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                        <span class="ml-3 flex-1">
                            <span class="text-sm font-semibold text-purple-900">Enable Fingerprint</span>
                            <span class="block text-xs text-purple-600">Quick unlock with biometric</span>
                        </span>
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
                        </svg>
                    </label>
                </div>
            </div>
            
            <div class="mt-6 flex gap-3">
                <button onclick="setupSecurity()" 
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 font-bold">
                    Setup Security
                </button>
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-4">
                ðŸ”’ Your 4-digit PIN is stored securely and cannot be recovered. Please remember it!
            </p>
        </div>
    </div>
    
    <!-- SECURITY UNLOCK MODAL -->
    <div id="security-unlock-modal" class="hidden fixed inset-0 bg-gradient-to-br from-indigo-500 to-purple-600 z-[1001] flex items-center justify-center p-4">
        <div class="p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-24 h-24 mx-auto mb-4">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                            <linearGradient id="unlockIconGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.95" />
                                <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.85" />
                            </linearGradient>
                        </defs>
                        <circle cx="50" cy="50" r="45" fill="url(#unlockIconGrad)"/>
                        <g transform="translate(50, 50)">
                            <rect x="-4" y="15" width="8" height="5" rx="1" fill="#667eea"/>
                            <ellipse cx="0" cy="26" rx="20" ry="10" fill="#667eea" opacity="0.9"/>
                            <ellipse cx="0" cy="0" rx="14" ry="16" fill="#667eea"/>
                            <rect x="-3" y="-16" width="6" height="3" fill="#f0f0f0"/>
                            <circle cx="0" cy="-22" r="1.5" fill="#4CAF50"/>
                            <path d="M -14 -8 Q -14 -18, 0 -20 Q 14 -18, 14 -8" stroke="#667eea" stroke-width="2.5" fill="none" stroke-linecap="round"/>
                            <g transform="translate(-17, 0)">
                                <ellipse cx="0" cy="0" rx="5" ry="7" fill="#667eea"/>
                                <ellipse cx="0" cy="0" rx="3.5" ry="5" fill="#818cf8"/>
                                <ellipse cx="0" cy="0" rx="2" ry="3" fill="#a5b4fc"/>
                            </g>
                            <g transform="translate(17, 0)">
                                <ellipse cx="0" cy="0" rx="5" ry="7" fill="#667eea"/>
                                <ellipse cx="0" cy="0" rx="3.5" ry="5" fill="#818cf8"/>
                                <ellipse cx="0" cy="0" rx="2" ry="3" fill="#a5b4fc"/>
                            </g>
                            <ellipse cx="-5" cy="-2" rx="3.5" ry="4.5" fill="#ffffff"/>
                            <ellipse cx="-5" cy="-2" rx="2" ry="2.5" fill="#e0e7ff"/>
                            <circle cx="-6" cy="-3" r="1" fill="#667eea"/>
                            <ellipse cx="5" cy="-2" rx="3.5" ry="4.5" fill="#ffffff"/>
                            <ellipse cx="5" cy="-2" rx="2" ry="2.5" fill="#e0e7ff"/>
                            <circle cx="4" cy="-3" r="1" fill="#667eea"/>
                            <path d="M -6 6 Q 0 10 6 6" stroke="#ffffff" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                            <path d="M 17 5 L 22 8" stroke="#667eea" stroke-width="1.2" stroke-linecap="round"/>
                            <circle cx="23" cy="9" r="2" fill="#667eea"/>
                            <rect x="-5" y="16" width="10" height="2" fill="#f8f9ff"/>
                            <circle cx="-3" cy="17" r="0.5" fill="#667eea"/>
                            <circle cx="0" cy="17" r="0.5" fill="#4CAF50"/>
                            <circle cx="3" cy="17" r="0.5" fill="#667eea"/>
                        </g>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-white drop-shadow-lg">
                    My Assistant
                </h2>
                <p class="text-white/80 text-xs mt-1">Enter your 4-digit PIN</p>
            </div>
            
            <div class="space-y-3">
                <div>
                    <input type="password" id="unlock-pin" inputmode="numeric" maxlength="4"
                           class="w-full px-3 py-3 border border-white/30 rounded-lg focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent text-center text-2xl tracking-widest font-semibold bg-white/20 backdrop-blur-sm text-white placeholder-white/60"
                           placeholder="â€¢â€¢â€¢â€¢"
                           oninput="handleUnlockPinInput()">
                </div>
                
                <button onclick="unlockWithPin()" 
                        class="w-full px-4 py-2.5 bg-white/90 hover:bg-white text-purple-700 rounded-lg hover:shadow-lg transition-all duration-200 font-semibold text-sm">
                    Unlock
                </button>
                
                <button id="biometric-unlock-btn" onclick="unlockWithBiometric()" 
                        class="hidden w-full px-4 py-2.5 bg-white/20 backdrop-blur-sm border border-white/30 text-white rounded-lg hover:bg-white/30 transition-all duration-200 font-medium text-sm flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4"/>
                    </svg>
                    Use Fingerprint
                </button>
            </div>
        </div>
    </div>
    
    <!-- CHANGE PIN MODAL -->
    <div id="change-pin-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-2xl font-bold mb-4 bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent flex items-center gap-2">
                <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                </svg>
                Change PIN
            </h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Current PIN</label>
                    <input type="password" id="change-current-pin" inputmode="numeric" maxlength="4"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-2xl tracking-widest font-bold"
                           placeholder="â€¢â€¢â€¢â€¢">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">New PIN (4 digits)</label>
                    <input type="password" id="change-new-pin" inputmode="numeric" maxlength="4"
                           class="w-full px-4 py-3 border-2 border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-2xl tracking-widest font-bold"
                           placeholder="â€¢â€¢â€¢â€¢">
                </div>
                
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Confirm New PIN</label>
                    <input type="password" id="change-confirm-pin" inputmode="numeric" maxlength="4"
                           class="w-full px-4 py-3 border-2 border-indigo-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-center text-2xl tracking-widest font-bold"
                           placeholder="â€¢â€¢â€¢â€¢">
                </div>
            </div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="changePin()" class="flex-1 px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Update PIN
                </button>
                <button onclick="closeChangePinModal()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
            </div>
            
            <p class="text-xs text-gray-500 text-center mt-4">
                ðŸ”’ Your PIN is stored securely. Make sure to remember your new PIN!
            </p>
        </div>
    </div>
    
    <!-- RESET APP MODAL -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full border-4 border-red-500">
            <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
            </div>
            
            <h2 class="text-2xl font-bold mb-3 text-center text-red-600">âš ï¸ Reset App Data</h2>
            <p class="text-gray-700 mb-4 text-center font-semibold">This will delete ALL your data:</p>
            
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <ul class="text-sm text-red-800 space-y-2">
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        All Expenses
                    </li>
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        All Credit Cards
                    </li>
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        All Investments
                    </li>
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        All Credentials
                    </li>
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        All Settings & AI Keys
                    </li>
                    <li class="flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        Chat History
                    </li>
                </ul>
            </div>
            
            <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-green-800 flex items-center">
                    <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span>Your data will be auto-exported as backup before reset</span>
                </p>
            </div>
            
            <p class="text-gray-600 text-sm mb-6 text-center italic">This action cannot be undone!</p>
            
            <div class="flex space-x-3">
                <button onclick="Navigation.closeResetModal()" class="flex-1 px-4 py-2.5 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
                <button onclick="Navigation.resetApp()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 font-bold">
                    Reset Everything
                </button>
            </div>
        </div>
    </div>

    
    <!-- TIP MODAL -->
    <div id="tip-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) closeTipModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <div class="flex items-start gap-3 mb-4">
                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">ðŸ’¡ Tip</h3>
                    <p id="tip-modal-text" class="text-sm text-gray-600"></p>
                </div>
            </div>
            <button onclick="closeTipModal()" class="w-full px-4 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                Got it!
            </button>
        </div>
    </div>
    
    <!-- MONTH RANGE MODAL -->
    <div id="month-range-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="if(event.target===this) Dashboard.closeMonthRangeModal()">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h2 class="text-xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-cyan-600 bg-clip-text text-transparent">Select Month Range</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Month *</label>
                <input type="month" id="month-range-start" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">End Month *</label>
                <input type="month" id="month-range-end" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <p class="text-xs text-gray-500 mb-4">Maximum range: 12 months</p>
            
            <div class="flex space-x-3">
                <button onclick="Dashboard.resetMonthRange()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Reset
                </button>
                <button onclick="Dashboard.applyMonthRange()" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Apply
                </button>
            </div>
        </div>
    </div>
    
    <!-- MANDATORY BACKUP CONFIRMATION MODAL -->
    <div id="backup-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <div class="flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mx-auto mb-4">
                <svg class="w-8 h-8 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M7.707 10.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 11.586V6h5a2 2 0 012 2v7a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2h5v5.586l-1.293-1.293zM9 4a1 1 0 012 0v2H9V4z"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-center mb-3 text-blue-600">ðŸ“¤ MANDATORY BACKUP</h2>
            <p class="text-gray-700 text-center mb-4 font-semibold">You MUST export your data as backup before reset.</p>
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-blue-800">
                    Your encrypted backup will be exported and you can save it to Google Drive, Email, or any location of your choice.
                </p>
            </div>
            <div class="flex space-x-3">
                <button onclick="Navigation.cancelBackupConfirm()" class="flex-1 px-4 py-2.5 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel Reset
                </button>
                <button onclick="Navigation.proceedWithExport()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 font-bold">
                    Export Now
                </button>
            </div>
        </div>
    </div>
    
    <!-- EXPORT SUCCESS CONFIRMATION MODAL -->
    <div id="export-success-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <div class="flex items-center justify-center w-16 h-16 bg-green-100 rounded-full mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-center mb-3 text-green-600">âœ… Export Completed!</h2>
            <p class="text-gray-700 text-center mb-4 font-semibold">Have you saved the backup file?</p>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-yellow-800">
                    âš ï¸ Make sure you have saved the backup file before proceeding with reset. Once reset, your data cannot be recovered without the backup!
                </p>
            </div>
            <div class="flex space-x-3">
                <button onclick="Navigation.cancelExportSuccess()" class="flex-1 px-4 py-2.5 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel Reset
                </button>
                <button onclick="Navigation.confirmBackupSaved()" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105 font-bold">
                    Yes, Proceed
                </button>
            </div>
        </div>
    </div>
    
    <!-- ERROR MODAL -->
    <div id="error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <div class="flex items-center justify-center w-16 h-16 bg-red-100 rounded-full mx-auto mb-4">
                <svg class="w-8 h-8 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            </div>
            <h2 id="error-modal-title" class="text-2xl font-bold text-center mb-3 text-red-600">âŒ Error</h2>
            <div id="error-modal-message" class="text-gray-700 text-center mb-4 whitespace-pre-line"></div>
            <button onclick="Navigation.closeErrorModal()" class="w-full px-4 py-2.5 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 font-semibold">
                OK
            </button>
        </div>
    </div>
    
    <!-- CUSTOM CONFIRM MODAL -->
    <div id="custom-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full animate-bounce-in">
            <div class="flex items-center justify-center w-16 h-16 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-full mx-auto mb-4">
                <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h2 id="confirm-modal-title" class="text-xl font-bold text-center mb-2 text-gray-900">Confirm Action</h2>
            <p id="confirm-modal-message" class="text-center text-gray-600 mb-6">Are you sure?</p>
            <div class="flex space-x-3">
                <button id="confirm-modal-cancel" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                    Cancel
                </button>
                <button id="confirm-modal-confirm" class="flex-1 px-4 py-2 bg-gradient-to-r from-red-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 transform hover:scale-105 font-semibold">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-0 left-0 right-0 bg-gray-900 text-white px-6 py-4 shadow-2xl z-[9999] font-bold text-left"></div>
    
    <!-- Tip Modal Functions -->
    <script>
        // Show tip modal with specific text
        function showTipModal(text) {
            const modal = document.getElementById('tip-modal');
            const textEl = document.getElementById('tip-modal-text');
            if (modal && textEl) {
                textEl.textContent = text;
                modal.classList.remove('hidden');
            }
        }
        
        // Close tip modal
        function closeTipModal() {
            const modal = document.getElementById('tip-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }
        
        // Show recurring expenses tip
        window.showRecurringTip = function() {
            showTipModal('Add recurring expenses like LIC premiums, insurance, subscriptions, etc. They\'ll be automatically added to your expenses on due dates.');
        }
        
        // Show loans tip
        window.showLoansTip = function() {
            showTipModal('Track your loans with EMI calculations. Monitor remaining balance and closure dates.');
        }
    </script>
    
    <!-- JavaScript Modules (Load in specific order) -->
    <!-- Core modules first -->
    <script src="js/core/database.js"></script>
    <script src="js/core/utils.js"></script>
    <script src="js/core/dataAccess.js"></script>
    <script src="js/utils/crypto.js"></script>
    <script src="js/utils/formatters.js"></script>
    <script src="js/utils/validators.js"></script>
    <script src="js/utils/calculations.js"></script>
    <script src="js/core/storage.js"></script>
    <script src="js/core/security.js"></script>
    <script src="js/core/loading.js"></script>
    <script src="js/core/stockapi.js"></script>
    
    <!-- AI modules -->
    <script src="js/ai/gemini.js"></script>
    <script src="js/ai/groq.js"></script>
    <script src="js/ai/chatgpt.js"></script>
    <script src="js/ai/perplexity.js"></script>
    <script src="js/ai/provider.js"></script>
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    
    <!-- Data modules -->
    <script src="js/modules/dashboard.js"></script>
    <script src="js/modules/credentials.js"></script>
    <script src="js/modules/cards.js"></script>
    <script src="js/modules/expenses.js"></script>
    <script src="js/modules/income.js"></script>
    <script src="js/modules/recurringExpenses.js"></script>
    <script src="js/modules/loans.js"></script>
    <script src="js/modules/investments.js"></script>
    
    <!-- UI modules -->
    <script src="js/ui/toast.js"></script>
    <script src="js/ui/modals.js"></script>
    <script src="js/ui/chat.js"></script>
    <script src="js/ui/navigation.js"></script>
    
    <!-- Main app initialization (must be last) -->
    <script src="js/app.js"></script>
    
    <!-- Form Handlers -->
    <script>
        // Format input as Indian currency (reuses Utils.formatIndianNumber)
        function formatIndianCurrency(input) {
            let value = input.value.replace(/,/g, ''); // Remove existing commas
            if (!value || isNaN(value)) {
                return;
            }
            input.value = Utils.formatIndianNumber(value);
        }
        
        // Form handler functions that call the module methods
        // Toggle credential form visibility
        function toggleCredentialForm() {
            const form = document.getElementById('credential-form');
            form.classList.toggle('hidden');
        }
        
        // Search credentials
        function searchCredentials() {
            const searchTerm = document.getElementById('credentials-search').value.toLowerCase();
            
            if (!searchTerm) {
                Credentials.render();
                return;
            }
            
            // Filter credentials
            const originalCredentials = [...window.DB.credentials];
            window.DB.credentials = window.DB.credentials.filter(cred => {
                const description = cred.description || cred.notes || '';
                return cred.service.toLowerCase().includes(searchTerm) ||
                    description.toLowerCase().includes(searchTerm) ||
                    (cred.additionalDetails && cred.additionalDetails.toLowerCase().includes(searchTerm)) ||
                    (cred.tag && cred.tag.toLowerCase().includes(searchTerm));
            });
            
            // Render filtered list using the module
            Credentials.render();
            
            // Restore original credentials
            window.DB.credentials = originalCredentials;
        }
        
        function handleAddCredential() {
            try {
                const service = document.getElementById('cred-service').value.trim();
                const username = document.getElementById('cred-username').value.trim();
                const password = document.getElementById('cred-password').value.trim();
                const notes = document.getElementById('cred-notes').value.trim();
                
                Credentials.add(service, username, password, notes);
                Credentials.render();
                
                // Clear form and hide it
                document.getElementById('cred-service').value = '';
                document.getElementById('cred-username').value = '';
                document.getElementById('cred-password').value = '';
                document.getElementById('cred-notes').value = '';
                document.getElementById('credential-form').classList.add('hidden');
                
                Utils.showSuccess('Credential added successfully!');
            } catch (error) {
                Utils.showError(error.message);
            }
        }
        
        // Card Modal Functions
        function calculateRemainingEMIs() {
            const firstDateInput = document.getElementById('emi-form-first-date');
            const totalInput = document.getElementById('emi-form-total');
            const infoDiv = document.getElementById('emi-auto-info');
            
            if (!firstDateInput.value) {
                infoDiv.classList.add('hidden');
                return;
            }
            
            const firstDate = new Date(firstDateInput.value);
            const today = new Date();
            
            // Calculate months between first EMI and today
            let monthsElapsed = (today.getFullYear() - firstDate.getFullYear()) * 12 
                              + (today.getMonth() - firstDate.getMonth());
            
            // If current date hasn't reached the EMI day this month, subtract 1
            if (today.getDate() < firstDate.getDate()) {
                monthsElapsed--;
            }
            
            if (monthsElapsed < 0) {
                infoDiv.innerHTML = 'ðŸ“… First EMI is in the future';
                infoDiv.classList.remove('hidden');
                return;
            }
            
            // Calculate actual paid EMIs (monthsElapsed represents completed months)
            // We add 1 because the first EMI month itself counts as 1 paid EMI
            const actualPaidEMIs = monthsElapsed + 1;
            
            // If total EMIs is specified, calculate based on that
            const totalEMIs = parseInt(totalInput.value);
            if (totalEMIs > 0) {
                const paidEMIs = Math.min(actualPaidEMIs, totalEMIs);
                const remainingEMIs = totalEMIs - paidEMIs;
                
                // Auto-fill paid EMIs
                document.getElementById('emi-form-paid').value = paidEMIs;
                
                if (remainingEMIs <= 0) {
                    infoDiv.innerHTML = 'âœ… All EMIs completed! This EMI will be auto-hidden.';
                    infoDiv.className = 'text-xs text-green-700 mb-3 p-2 bg-green-50 rounded-lg';
                } else {
                    infoDiv.innerHTML = `ðŸ“Š Auto-calculated: ${paidEMIs} paid, ${remainingEMIs} remaining (${Math.round((paidEMIs/totalEMIs)*100)}% complete)`;
                    infoDiv.className = 'text-xs text-blue-700 mb-3 p-2 bg-blue-50 rounded-lg';
                }
                infoDiv.classList.remove('hidden');
            } else {
                infoDiv.innerHTML = `ðŸ“… ${actualPaidEMIs} EMI(s) paid since first EMI date`;
                infoDiv.classList.remove('hidden');
            }
        }
        
        function formatCardExpiry(input) {
            let value = input.value.replace(/\D/g, ''); // Remove non-digits
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            input.value = value;
        }
        
        // Toggle credit-only fields based on card type
        window.toggleCreditOnlyFields = function() {
            const cardType = document.getElementById('card-modal-type').value;
            const creditOnlyFields = document.getElementById('credit-only-fields');
            
            if (cardType === 'debit') {
                creditOnlyFields.style.display = 'none';
            } else {
                creditOnlyFields.style.display = 'block';
            }
        }
        
        window.openCardModal = function(id = null) {
            console.log('=== OPEN CARD MODAL DEBUG ===');
            console.log('Received ID:', id, 'Type:', typeof id);
            
            // Always clear fields first
            document.getElementById('card-modal-title').textContent = 'Add Card';
            document.getElementById('card-modal-id').value = '';
            document.getElementById('card-modal-type').value = Cards.currentTab; // Default to current tab
            document.getElementById('card-modal-name').value = '';
            document.getElementById('card-modal-number').value = '';
            document.getElementById('card-modal-expiry').value = '';
            document.getElementById('card-modal-cvv').value = '';
            document.getElementById('card-modal-credit-limit').value = '';
            document.getElementById('card-modal-additional-data').value = '';
            
            if (id) {
                // Edit mode - populate with existing data
                // Convert both to string for type-safe comparison
                const searchId = String(id);
                console.log('Searching for card with ID:', searchId);
                console.log('Available cards:', window.DB.cards.map(c => ({ id: c.id, type: typeof c.id, name: c.name })));
                
                const card = window.DB.cards.find(c => String(c.id) === searchId);
                console.log('Found card:', card);
                
                if (card) {
                    document.getElementById('card-modal-title').textContent = 'Edit Card';
                    document.getElementById('card-modal-id').value = card.id;
                    document.getElementById('card-modal-type').value = card.cardType || 'credit';
                    document.getElementById('card-modal-name').value = card.name;
                    document.getElementById('card-modal-number').value = card.cardNumber;
                    document.getElementById('card-modal-expiry').value = card.expiry;
                    document.getElementById('card-modal-cvv').value = card.cvv;
                    document.getElementById('card-modal-credit-limit').value = card.creditLimit || '';
                    document.getElementById('card-modal-additional-data').value = card.additionalData || '';
                    console.log('Modal populated with card data. Hidden ID field value:', document.getElementById('card-modal-id').value);
                } else {
                    console.error('Card not found in openCardModal! ID:', id);
                }
            }
            
            toggleCreditOnlyFields(); // Show/hide credit-only fields
            document.getElementById('card-modal').classList.remove('hidden');
        }
        
        window.closeCardModal = function() {
            clearAllFormErrors('card-modal');
            document.getElementById('card-modal').classList.add('hidden');
        };
        
        window.saveCardModal = async function() {
            // Clear all previous errors
            clearAllFormErrors('card-modal');
            
            const id = document.getElementById('card-modal-id').value;
            const cardType = document.getElementById('card-modal-type').value;
            const name = document.getElementById('card-modal-name').value.trim();
            const cardNumber = document.getElementById('card-modal-number').value.trim();
            const expiry = document.getElementById('card-modal-expiry').value.trim();
            const cvv = document.getElementById('card-modal-cvv').value.trim();
            const creditLimit = document.getElementById('card-modal-credit-limit').value.trim();
            const additionalData = document.getElementById('card-modal-additional-data').value.trim();
            
            let hasErrors = false;
            
            // Validate name
            if (!name) {
                showFieldError('card-modal-name', 'Card name is required');
                hasErrors = true;
            }
            
            // Validate card number
            if (!cardNumber) {
                showFieldError('card-modal-number', 'Card number is required');
                hasErrors = true;
            } else {
                const cleanCardNumber = cardNumber.replace(/\s/g, '');
                if (!/^\d{13,19}$/.test(cleanCardNumber)) {
                    showFieldError('card-modal-number', 'Invalid card number (13-19 digits required)');
                    hasErrors = true;
                }
            }
            
            // Validate expiry
            if (!expiry) {
                showFieldError('card-modal-expiry', 'Expiry date is required');
                hasErrors = true;
            } else if (!/^\d{2}\/\d{2,4}$/.test(expiry)) {
                showFieldError('card-modal-expiry', 'Invalid format (use MM/YY)');
                hasErrors = true;
            }
            
            // Validate CVV
            if (!cvv) {
                showFieldError('card-modal-cvv', 'CVV is required');
                hasErrors = true;
            } else if (!/^\d{3,4}$/.test(cvv)) {
                showFieldError('card-modal-cvv', 'Invalid CVV (3-4 digits)');
                hasErrors = true;
            }
            
            // Validate credit limit (if credit card)
            if (cardType === 'credit' && creditLimit) {
                const limit = parseInt(creditLimit.replace(/[â‚¹,\s]/g, ''));
                if (isNaN(limit) || limit <= 0) {
                    showFieldError('card-modal-credit-limit', 'Invalid credit limit');
                    hasErrors = true;
                }
            }
            
            // If there are errors, stop here
            if (hasErrors) {
                return;
            }
            
            try {
                Loading.show('Saving card...');
                
                if (id) {
                    // Update existing
                    await Cards.update(id, name, cardNumber, expiry, cvv, additionalData, creditLimit, cardType);
                    Utils.showSuccess('Card updated!');
                } else {
                    // Add new
                    await Cards.add(name, cardNumber, expiry, cvv, additionalData, creditLimit, cardType);
                    Utils.showSuccess('Card added!');
                }
                
                Cards.render();
                closeCardModal();
                Loading.hide();
            } catch (error) {
                Loading.hide();
                console.error('Error saving card:', error);
                // Unexpected errors still show modal
                Utils.showError(error.message);
            }
        }
        
        // Search cards
        function searchCards() {
            const searchTerm = document.getElementById('cards-search').value.toLowerCase();
            const cards = document.querySelectorAll('#cards-list > div');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Toggle expense form visibility
        function toggleExpenseForm() {
            const form = document.getElementById('expense-form');
            form.classList.toggle('hidden');
        }
        
        // Search expenses (now integrated with filtering)
        function searchExpenses() {
            if (!window.Expenses) return;
            const searchTerm = document.getElementById('expenses-search').value;
            Expenses.updateFilters(undefined, undefined, searchTerm);
        }
        
        // Update expense filters
        function updateExpenseFilters() {
            const startDate = document.getElementById('expense-start-date').value;
            const endDate = document.getElementById('expense-end-date').value;
            const searchTerm = document.getElementById('expenses-search').value;
            Expenses.updateFilters(startDate, endDate, searchTerm);
        }
        
        // Set to current month
        function setExpenseCurrentMonth() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            
            document.getElementById('expense-start-date').value = `${year}-${month}-01`;
            document.getElementById('expense-end-date').value = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
            updateExpenseFilters();
        }
        
        // Set to all time
        function setExpenseAllTime() {
            if (window.DB.expenses.length === 0) {
                Utils.showInfo('No expenses yet');
                return;
            }
            
            // Find earliest and latest dates
            const dates = window.DB.expenses.map(e => new Date(e.date));
            const earliest = new Date(Math.min(...dates));
            const latest = new Date(Math.max(...dates));
            
            document.getElementById('expense-start-date').value = earliest.toISOString().split('T')[0];
            document.getElementById('expense-end-date').value = latest.toISOString().split('T')[0];
            updateExpenseFilters();
        }
        
        // Toggle investment form visibility
        function toggleInvestmentForm() {
            const form = document.getElementById('investment-form');
            form.classList.toggle('hidden');
        }
        
        // Filter investments by type
        function filterInvestments() {
            searchInvestments(); // Trigger search with current filters
        }
        
        // Search investments (includes both existing portfolio and monthly investments)
        function searchInvestments() {
            Investments.render(); // Re-renders both portfolio and monthly investments with search
        }
        
        // Date filter for monthly investments
        function openInvestmentDateFilterModal() {
            document.getElementById('investment-date-filter-modal').classList.remove('hidden');
        }
        
        function closeInvestmentDateFilterModal() {
            document.getElementById('investment-date-filter-modal').classList.add('hidden');
        }
        
        function toggleCustomDateFields() {
            const isCustom = document.querySelector('input[name="investment-date-filter"]:checked').value === 'custom';
            const customFields = document.getElementById('custom-date-fields');
            
            if (isCustom) {
                customFields.classList.remove('hidden');
                // Set default dates
                const today = new Date();
                const sixMonthsAgo = new Date();
                sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                
                document.getElementById('investment-filter-start-date').value = sixMonthsAgo.toISOString().split('T')[0];
                document.getElementById('investment-filter-end-date').value = today.toISOString().split('T')[0];
            } else {
                customFields.classList.add('hidden');
            }
        }
        
        function applyInvestmentDateFilter() {
            const filterType = document.querySelector('input[name="investment-date-filter"]:checked').value;
            let startDate = null;
            let endDate = null;
            
            const today = new Date();
            
            switch(filterType) {
                case 'current':
                    // Current month
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    break;
                    
                case '6months':
                    // Last 6 months
                    startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 6);
                    endDate = today;
                    break;
                    
                case 'year':
                    // This year
                    startDate = new Date(today.getFullYear(), 0, 1);
                    endDate = today;
                    break;
                    
                case 'all':
                    // All time - no date restriction
                    break;
                    
                case 'custom':
                    // Custom range
                    const startInput = document.getElementById('investment-filter-start-date').value;
                    const endInput = document.getElementById('investment-filter-end-date').value;
                    
                    if (!startInput || !endInput) {
                        Utils.showError('Please select both start and end dates');
                        return;
                    }
                    
                    startDate = new Date(startInput);
                    endDate = new Date(endInput);
                    
                    if (startDate > endDate) {
                        Utils.showError('Start date must be before end date');
                        return;
                    }
                    break;
            }
            
            // Store filter in window for use by render function
            window.investmentDateFilter = {
                type: filterType,
                startDate: startDate,
                endDate: endDate
            };
            
            // Re-render with filter
            Investments.renderMonthlyInvestments();
            closeInvestmentDateFilterModal();
            
            Utils.showSuccess('Filter applied successfully!');
        }
        
        // Switch between Income and Expenses tabs
        function switchIncomeExpenseTab(tab) {
            const expensesTab = document.getElementById('expenses-tab');
            const incomeTab = document.getElementById('income-tab');
            const expensesContent = document.getElementById('expenses-tab-content');
            const incomeContent = document.getElementById('income-tab-content');
            const addButton = document.getElementById('expenses-add-btn');
            
            // Check if elements exist (they may not be present on all pages)
            if (!expensesTab || !incomeTab || !expensesContent || !incomeContent || !addButton) {
                console.warn('switchIncomeExpenseTab: Required elements not found on this page');
                return;
            }
            
            if (tab === 'expenses') {
                // Show expenses tab
                expensesTab.className = 'flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-md';
                expensesTab.style.cssText = 'flex-shrink: 0;';
                incomeTab.className = 'flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gray-200 text-gray-700 hover:bg-gray-300';
                incomeTab.style.cssText = 'flex-shrink: 0;';
                expensesContent.classList.remove('hidden');
                incomeContent.classList.add('hidden');
                
                // Always show + button for expenses
                addButton.onclick = openExpenseModal;
                addButton.className = 'py-3 px-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all font-medium text-sm flex items-center';
                addButton.style.cssText = 'flex-shrink: 0;';
                addButton.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>';
                addButton.classList.remove('hidden');
                
                // Render expenses if not already rendered
                if (window.Expenses) {
                    window.Expenses.render();
                }
            } else if (tab === 'income') {
                // Show income tab
                expensesTab.className = 'flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gray-200 text-gray-700 hover:bg-gray-300';
                expensesTab.style.cssText = 'flex-shrink: 0;';
                incomeTab.className = 'flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-md';
                incomeTab.style.cssText = 'flex-shrink: 0;';
                expensesContent.classList.add('hidden');
                incomeContent.classList.remove('hidden');
                
                // Check if income data exists
                const incomeData = window.DB.income || {};
                const hasIncome = incomeData.ctc && incomeData.ctc > 0;
                
                if (hasIncome) {
                    // Income exists - disable + button but keep it visible for layout
                    addButton.disabled = true;
                    addButton.onclick = null;
                    addButton.className = 'py-3 px-3 bg-gray-300 text-gray-500 rounded-lg cursor-not-allowed font-medium text-sm flex items-center';
                    addButton.style.cssText = 'flex-shrink: 0; opacity: 0.5;';
                    addButton.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>';
                } else {
                    // No income - enable + button
                    addButton.disabled = false;
                    addButton.onclick = function() { Income.openForm(); };
                    addButton.className = 'py-3 px-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all font-medium text-sm flex items-center';
                    addButton.style.cssText = 'flex-shrink: 0;';
                    addButton.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/></svg>';
                }
                
                // Render income if not already rendered
                if (window.Income) {
                    window.Income.render();
                }
            }
        }
        
        // Make it globally accessible
        window.switchIncomeExpenseTab = switchIncomeExpenseTab;
        
        // Expense modal functions
        window.openExpenseModal = function(id = null) {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            
            // Clear fields first
            document.getElementById('expense-modal-id').value = '';
            document.getElementById('expense-modal-title').value = '';
            document.getElementById('expense-modal-description').value = '';
            document.getElementById('expense-modal-amount').value = '';
            document.getElementById('expense-modal-category').value = '';
            document.getElementById('expense-modal-date').value = today;
            document.getElementById('expense-modal-title-header').textContent = 'Add Expense';
            document.getElementById('expense-modal-save-btn').textContent = 'Add';
            
            // If editing, populate with existing data
            if (id) {
                const expense = window.DB.expenses.find(e => e.id == id || String(e.id) === String(id));
                if (expense) {
                    document.getElementById('expense-modal-id').value = expense.id;
                    document.getElementById('expense-modal-title').value = expense.title || expense.description || '';
                    document.getElementById('expense-modal-description').value = expense.description || '';
                    document.getElementById('expense-modal-amount').value = expense.amount || '';
                    document.getElementById('expense-modal-category').value = expense.category || '';
                    document.getElementById('expense-modal-date').value = expense.date || today;
                    document.getElementById('expense-modal-title-header').textContent = 'Edit Expense';
                    document.getElementById('expense-modal-save-btn').textContent = 'Update';
                }
            }
            
            document.getElementById('expense-modal').classList.remove('hidden');
        }
        
        window.closeExpenseModal = function() {
            clearAllFormErrors('expense-modal');
            document.getElementById('expense-modal').classList.add('hidden');
            hideExpenseSuggestions();
        }
        
        // Expense Autocomplete Functions
        window.showExpenseSuggestions = function(searchTerm) {
            const suggestionsDiv = document.getElementById('expense-suggestions');
            
            if (!searchTerm || searchTerm.length < 2) {
                hideExpenseSuggestions();
                return;
            }
            
            // Get unique expense titles with their details
            const expensesMap = new Map();
            window.DB.expenses.forEach(exp => {
                const title = exp.title || exp.description;
                if (title && title.toLowerCase().includes(searchTerm.toLowerCase())) {
                    if (!expensesMap.has(title)) {
                        expensesMap.set(title, {
                            title: title,
                            category: exp.category,
                            amount: exp.amount,
                            description: exp.description
                        });
                    }
                }
            });
            
            const suggestions = Array.from(expensesMap.values());
            
            if (suggestions.length === 0) {
                hideExpenseSuggestions();
                return;
            }
            
            // Limit to 8 suggestions
            const limitedSuggestions = suggestions.slice(0, 8);
            
            suggestionsDiv.innerHTML = limitedSuggestions.map(suggestion => `
                <div class="p-3 hover:bg-purple-50 cursor-pointer border-b border-gray-100 last:border-b-0 transition-colors"
                     onclick="selectExpenseSuggestion(${JSON.stringify(suggestion).replace(/"/g, '&quot;')})">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 text-sm">${Utils.escapeHtml(suggestion.title)}</p>
                            ${suggestion.category ? `<p class="text-xs text-gray-500">${Utils.escapeHtml(suggestion.category)}</p>` : ''}
                        </div>
                        ${suggestion.amount ? `<span class="text-sm font-medium text-purple-600">â‚¹${suggestion.amount.toLocaleString()}</span>` : ''}
                    </div>
                </div>
            `).join('');
            
            suggestionsDiv.classList.remove('hidden');
        }
        
        window.hideExpenseSuggestions = function() {
            const suggestionsDiv = document.getElementById('expense-suggestions');
            suggestionsDiv.classList.add('hidden');
            suggestionsDiv.innerHTML = '';
        }
        
        window.selectExpenseSuggestion = function(suggestion) {
            document.getElementById('expense-modal-title').value = suggestion.title;
            if (suggestion.category) {
                document.getElementById('expense-modal-category').value = suggestion.category;
            }
            if (suggestion.amount) {
                document.getElementById('expense-modal-amount').value = suggestion.amount;
            }
            if (suggestion.description) {
                document.getElementById('expense-modal-description').value = suggestion.description;
            }
            hideExpenseSuggestions();
            // Focus on amount field if it's empty
            if (!suggestion.amount) {
                document.getElementById('expense-modal-amount').focus();
            }
        }
        
        // Close suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const suggestionsDiv = document.getElementById('expense-suggestions');
            const titleInput = document.getElementById('expense-modal-title');
            if (suggestionsDiv && titleInput && 
                !suggestionsDiv.contains(e.target) && e.target !== titleInput) {
                hideExpenseSuggestions();
            }
        });
        
        window.saveExpenseModal = function() {
            // Safety check
            if (!window.Expenses) {
                Utils.showError('Expenses module not loaded. Please refresh the page.');
                return;
            }
            
            // Clear all previous errors
            clearAllFormErrors('expense-modal');
            
            const id = document.getElementById('expense-modal-id').value;
            const title = document.getElementById('expense-modal-title').value.trim();
            const amount = document.getElementById('expense-modal-amount').value.trim();
            const category = document.getElementById('expense-modal-category').value;
            const date = document.getElementById('expense-modal-date').value;
            const description = document.getElementById('expense-modal-description').value.trim();
            
            let hasErrors = false;
            
            // Validate title
            if (!title) {
                showFieldError('expense-modal-title', 'Title is required');
                hasErrors = true;
            }
            
            // Validate amount
            if (!amount) {
                showFieldError('expense-modal-amount', 'Amount is required');
                hasErrors = true;
            } else if (parseFloat(amount) <= 0) {
                showFieldError('expense-modal-amount', 'Amount must be greater than 0');
                hasErrors = true;
            }
            
            // Validate category
            if (!category) {
                showFieldError('expense-modal-category', 'Category is required');
                hasErrors = true;
            }
            
            // Validate date
            if (!date) {
                showFieldError('expense-modal-date', 'Date is required');
                hasErrors = true;
            }
            
            // If there are errors, stop here
            if (hasErrors) {
                return;
            }
            
            try {
                Loading.show(id ? 'Updating expense...' : 'Adding expense...');
                
                if (id) {
                    // Update existing expense
                    const expense = window.DB.expenses.find(e => e.id == id);
                    if (expense) {
                        expense.title = title;
                        expense.amount = parseFloat(amount);
                        expense.category = category;
                        expense.date = date;
                        expense.description = description;
                        window.Storage.save();
                    }
                    Utils.showSuccess('Expense updated!');
                } else {
                    // Add new expense
                    Expenses.add(title, amount, category, date, description);
                    Utils.showSuccess('Expense added!');
                }
                
                Expenses.render();
                closeExpenseModal();
                Loading.hide();
            } catch (error) {
                Loading.hide();
                // Unexpected errors still show modal
                Utils.showError(error.message);
            }
        }
        
        // Date filter modal functions
        window.openDateFilterModal = function() {
            if (!window.Expenses) return;
            
            const startDate = Expenses.startDate || '';
            const endDate = Expenses.endDate || '';
            
            document.getElementById('filter-start-date').value = startDate;
            document.getElementById('filter-end-date').value = endDate;
            
            document.getElementById('date-filter-modal').classList.remove('hidden');
        }
        
        window.closeDateFilterModal = function() {
            document.getElementById('date-filter-modal').classList.add('hidden');
        }
        
        window.applyQuickFilter = function(type) {
            if (!window.Expenses) return;
            
            const today = new Date();
            let startDate, endDate, label;
            
            switch(type) {
                case 'today':
                    const todayYear = today.getFullYear();
                    const todayMonth = String(today.getMonth() + 1).padStart(2, '0');
                    const todayDay = String(today.getDate()).padStart(2, '0');
                    startDate = endDate = `${todayYear}-${todayMonth}-${todayDay}`;
                    label = 'Today';
                    break;
                case 'week':
                    // Last 7 days (today to 6 days ago)
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - 6);
                    const weekStartYear = weekStart.getFullYear();
                    const weekStartMonth = String(weekStart.getMonth() + 1).padStart(2, '0');
                    const weekStartDay = String(weekStart.getDate()).padStart(2, '0');
                    const weekEndYear = today.getFullYear();
                    const weekEndMonth = String(today.getMonth() + 1).padStart(2, '0');
                    const weekEndDay = String(today.getDate()).padStart(2, '0');
                    startDate = `${weekStartYear}-${weekStartMonth}-${weekStartDay}`;
                    endDate = `${weekEndYear}-${weekEndMonth}-${weekEndDay}`;
                    label = 'Last 7 Days';
                    break;
                case 'month':
                    // Full current month (1st to last day)
                    const monthYear = today.getFullYear();
                    const monthNum = String(today.getMonth() + 1).padStart(2, '0');
                    const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
                    startDate = `${monthYear}-${monthNum}-01`;
                    endDate = `${monthYear}-${monthNum}-${String(lastDay).padStart(2, '0')}`;
                    label = 'Current Month';
                    break;
                case 'year':
                    // Full current year (Jan 1 to Dec 31)
                    const yearNum = today.getFullYear();
                    const todayYearMonth = String(today.getMonth() + 1).padStart(2, '0');
                    const todayYearDay = String(today.getDate()).padStart(2, '0');
                    startDate = `${yearNum}-01-01`;
                    endDate = `${yearNum}-${todayYearMonth}-${todayYearDay}`;
                    label = 'This Year';
                    break;
                case 'all':
                    startDate = '2020-01-01';
                    endDate = `${today.getFullYear() + 10}-12-31`;
                    label = 'All Time';
                    break;
            }
            
            Expenses.startDate = startDate;
            Expenses.endDate = endDate;
            Expenses.currentPage = 1;
            Expenses.render();
            
            const filterLabel = document.getElementById('date-filter-label');
            const filterLabelInfo = document.getElementById('date-filter-label-info');
            if (filterLabel) filterLabel.textContent = label;
            if (filterLabelInfo) filterLabelInfo.textContent = label;
            
            closeDateFilterModal();
        }
        
        // Recurring Expense Modal Functions
        window.openRecurringExpenseModal = function(id = null) {
            // Clear fields
            document.getElementById('recurring-modal-id').value = '';
            document.getElementById('recurring-modal-name').value = '';
            document.getElementById('recurring-modal-amount').value = '';
            document.getElementById('recurring-modal-frequency').value = '';
            document.getElementById('recurring-modal-day').value = '';
            document.getElementById('recurring-modal-end-date').value = '';
            document.getElementById('recurring-modal-indefinite').checked = true;
            document.getElementById('recurring-modal-end-date').disabled = true;
            document.getElementById('recurring-modal-description').value = '';
            document.getElementById('recurring-modal-title').textContent = 'Add Recurring Payment';
            
            // Hide months section by default
            document.getElementById('recurring-months-section').classList.add('hidden');
            
            // Uncheck all month checkboxes
            document.querySelectorAll('#recurring-months-section input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            // If editing, populate with existing data
            if (id) {
                const recurring = window.RecurringExpenses.getById(id);
                if (recurring) {
                    document.getElementById('recurring-modal-id').value = recurring.id;
                    document.getElementById('recurring-modal-name').value = recurring.name;
                    document.getElementById('recurring-modal-amount').value = recurring.amount;
                    document.getElementById('recurring-modal-frequency').value = recurring.frequency;
                    document.getElementById('recurring-modal-day').value = recurring.day;
                    document.getElementById('recurring-modal-description').value = recurring.description || '';
                    document.getElementById('recurring-modal-title').textContent = 'Edit Recurring Payment';
                    
                    // Handle end date
                    if (recurring.endDate) {
                        const endDate = new Date(recurring.endDate);
                        const endDateStr = `${endDate.getFullYear()}-${String(endDate.getMonth() + 1).padStart(2, '0')}`;
                        document.getElementById('recurring-modal-end-date').value = endDateStr;
                        document.getElementById('recurring-modal-indefinite').checked = false;
                        document.getElementById('recurring-modal-end-date').disabled = false;
                    } else {
                        document.getElementById('recurring-modal-indefinite').checked = true;
                        document.getElementById('recurring-modal-end-date').disabled = true;
                    }
                    
                    // Show months section if needed and check appropriate months
                    if (recurring.frequency === 'yearly' || recurring.frequency === 'custom') {
                        document.getElementById('recurring-months-section').classList.remove('hidden');
                        if (recurring.months && recurring.months.length > 0) {
                            recurring.months.forEach(month => {
                                const checkbox = document.querySelector(`#recurring-months-section input[value="${month}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                    }
                }
            }
            
            document.getElementById('recurring-expense-modal').classList.remove('hidden');
        }
        
        window.toggleEndDate = function() {
            const indefiniteChecked = document.getElementById('recurring-modal-indefinite').checked;
            const endDateInput = document.getElementById('recurring-modal-end-date');
            
            if (indefiniteChecked) {
                endDateInput.value = '';
                endDateInput.disabled = true;
            } else {
                endDateInput.disabled = false;
            }
        }
        
        window.closeRecurringExpenseModal = function() {
            clearAllFormErrors('recurring-expense-modal');
            document.getElementById('recurring-expense-modal').classList.add('hidden');
        }
        
        window.updateRecurringFrequency = function() {
            const frequency = document.getElementById('recurring-modal-frequency').value;
            const monthsSection = document.getElementById('recurring-months-section');
            
            if (frequency === 'yearly' || frequency === 'custom') {
                monthsSection.classList.remove('hidden');
            } else {
                monthsSection.classList.add('hidden');
            }
        }
        
        // Helper function to show field error
        window.showFieldError = function(fieldId, message) {
            const errorDiv = document.getElementById(fieldId + '-error');
            const inputField = document.getElementById(fieldId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
            }
            if (inputField) {
                inputField.classList.add('border-red-500');
                inputField.classList.remove('border-gray-300');
            }
        }
        
        // Helper function to clear field error
        window.clearFieldError = function(fieldId) {
            const errorDiv = document.getElementById(fieldId + '-error');
            const inputField = document.getElementById(fieldId);
            if (errorDiv) {
                errorDiv.classList.add('hidden');
            }
            if (inputField) {
                inputField.classList.remove('border-red-500');
                inputField.classList.add('border-gray-300');
            }
        }
        
        // Helper function to clear all form errors
        window.clearAllFormErrors = function(formId) {
            const form = document.getElementById(formId);
            if (form) {
                form.querySelectorAll('[id$="-error"]').forEach(errorDiv => {
                    errorDiv.classList.add('hidden');
                });
                form.querySelectorAll('input, select, textarea').forEach(input => {
                    input.classList.remove('border-red-500');
                    input.classList.add('border-gray-300');
                });
            }
        }
        
        window.saveRecurringExpenseModal = function() {
            // Clear all previous errors
            clearAllFormErrors('recurring-expense-modal');
            
            const id = document.getElementById('recurring-modal-id').value;
            const name = document.getElementById('recurring-modal-name').value.trim();
            const amount = document.getElementById('recurring-modal-amount').value.trim();
            const frequency = document.getElementById('recurring-modal-frequency').value;
            const day = document.getElementById('recurring-modal-day').value.trim();
            const description = document.getElementById('recurring-modal-description').value.trim();
            const indefinite = document.getElementById('recurring-modal-indefinite').checked;
            
            let hasErrors = false;
            
            // Validate name
            if (!name) {
                showFieldError('recurring-modal-name', 'Name is required');
                hasErrors = true;
            }
            
            // Validate amount
            if (!amount) {
                showFieldError('recurring-modal-amount', 'Amount is required');
                hasErrors = true;
            } else if (parseFloat(amount) <= 0) {
                showFieldError('recurring-modal-amount', 'Amount must be greater than 0');
                hasErrors = true;
            }
            
            // Validate frequency
            if (!frequency) {
                showFieldError('recurring-modal-frequency', 'Frequency is required');
                hasErrors = true;
            }
            
            // Validate day
            if (!day) {
                showFieldError('recurring-modal-day', 'Day is required');
                hasErrors = true;
            } else if (parseInt(day) < 1 || parseInt(day) > 31) {
                showFieldError('recurring-modal-day', 'Day must be between 1 and 31');
                hasErrors = true;
            }
            
            // Get selected months
            const months = [];
            if (frequency === 'yearly' || frequency === 'custom') {
                document.querySelectorAll('#recurring-months-section input[type="checkbox"]:checked').forEach(cb => {
                    months.push(parseInt(cb.value));
                });
                
                if (months.length === 0) {
                    showFieldError('recurring-modal-months', 'Please select at least one month');
                    hasErrors = true;
                }
                
                // For yearly, ensure only one month is selected
                if (frequency === 'yearly' && months.length > 1) {
                    showFieldError('recurring-modal-months', 'Yearly frequency should have only ONE month. Use Custom for multiple months.');
                    hasErrors = true;
                }
            }
            
            // If there are errors, stop here
            if (hasErrors) {
                return;
            }
            
            // Get end date
            let endDate = null;
            if (!indefinite) {
                const endDateValue = document.getElementById('recurring-modal-end-date').value;
                if (endDateValue) {
                    // Convert YYYY-MM to YYYY-MM-01 (last day of the month)
                    const [year, month] = endDateValue.split('-');
                    const lastDay = new Date(parseInt(year), parseInt(month), 0).getDate();
                    endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
                }
            }
            
            try {
                if (id) {
                    // Update existing
                    window.RecurringExpenses.update(id, name, amount, frequency, day, months, description, endDate);
                    Utils.showSuccess('Recurring expense updated!');
                } else {
                    // Add new
                    window.RecurringExpenses.add(name, amount, frequency, day, months, description, endDate);
                    Utils.showSuccess('Recurring expense added!');
                }
                
                window.RecurringExpenses.render();
                closeRecurringExpenseModal();
            } catch (error) {
                // Unexpected errors still show modal
                Utils.showError(error.message);
            }
        }
        
        // Tab switching for Recurring/Loans
        window.switchRecurringTab = function(tab) {
            const recurringTab = document.getElementById('recurring-tab');
            const loansTab = document.getElementById('loans-tab');
            const recurringContent = document.getElementById('recurring-tab-content');
            const loansContent = document.getElementById('loans-tab-content');
            const addBtn = document.getElementById('recurring-add-btn');
            
            if (tab === 'recurring') {
                recurringTab.className = 'flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gradient-to-r from-orange-600 to-amber-600 text-white shadow-md';
                recurringTab.style.cssText = 'flex-shrink: 0;';
                loansTab.className = 'flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gray-200 text-gray-700 hover:bg-gray-300';
                loansTab.style.cssText = 'flex-shrink: 0;';
                recurringContent.classList.remove('hidden');
                loansContent.classList.add('hidden');
                addBtn.onclick = () => openRecurringExpenseModal();
            } else {
                recurringTab.className = 'flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gray-200 text-gray-700 hover:bg-gray-300';
                recurringTab.style.cssText = 'flex-shrink: 0;';
                loansTab.className = 'flex-1 py-3 px-3 rounded-lg transition-all font-medium text-sm bg-gradient-to-r from-orange-600 to-amber-600 text-white shadow-md';
                loansTab.style.cssText = 'flex-shrink: 0;';
                recurringContent.classList.add('hidden');
                loansContent.classList.remove('hidden');
                addBtn.onclick = () => openLoanModal();
            }
        }
        
        // Toggle custom loan type field
        window.toggleCustomLoanType = function() {
            const loanType = document.getElementById('loan-modal-type').value;
            const customSection = document.getElementById('custom-loan-type-section');
            
            if (loanType === 'Other') {
                customSection.classList.remove('hidden');
            } else {
                customSection.classList.add('hidden');
                document.getElementById('loan-modal-custom-type').value = '';
            }
        }
        
        // Loan Modal Functions
        window.openLoanModal = function(id = null) {
            document.getElementById('loan-modal-title').textContent = id ? 'Edit Loan' : 'Add Loan';
            document.getElementById('loan-modal-id').value = '';
            document.getElementById('loan-modal-bank').value = '';
            document.getElementById('loan-modal-type').value = '';
            document.getElementById('loan-modal-custom-type').value = '';
            document.getElementById('loan-modal-reason').value = '';
            document.getElementById('loan-modal-amount').value = '';
            document.getElementById('loan-modal-interest').value = '';
            document.getElementById('loan-modal-tenure').value = '';
            document.getElementById('loan-modal-first-emi-date').value = '';
            document.getElementById('custom-loan-type-section').classList.add('hidden');
            
            if (id) {
                const loan = window.Loans.getById(id);
                if (loan) {
                    document.getElementById('loan-modal-id').value = loan.id;
                    document.getElementById('loan-modal-bank').value = loan.bankName;
                    
                    // Set loan type
                    const predefinedTypes = ['Personal', 'Home', 'Car', 'Gold'];
                    if (predefinedTypes.includes(loan.loanType)) {
                        document.getElementById('loan-modal-type').value = loan.loanType;
                    } else {
                        document.getElementById('loan-modal-type').value = 'Other';
                        document.getElementById('loan-modal-custom-type').value = loan.loanType;
                        document.getElementById('custom-loan-type-section').classList.remove('hidden');
                    }
                    
                    document.getElementById('loan-modal-reason').value = loan.reason || '';
                    document.getElementById('loan-modal-amount').value = loan.amount;
                    document.getElementById('loan-modal-interest').value = loan.interestRate;
                    document.getElementById('loan-modal-tenure').value = loan.tenure;
                    document.getElementById('loan-modal-first-emi-date').value = loan.firstEmiDate;
                }
            }
            
            document.getElementById('loan-modal').classList.remove('hidden');
        }
        
        window.closeLoanModal = function() {
            clearAllFormErrors('loan-modal');
            document.getElementById('loan-modal').classList.add('hidden');
        }
        
        window.saveLoanModal = function() {
            // Clear all previous errors
            clearAllFormErrors('loan-modal');
            
            const id = document.getElementById('loan-modal-id').value;
            const bankName = document.getElementById('loan-modal-bank').value.trim();
            const loanTypeSelect = document.getElementById('loan-modal-type').value;
            const customLoanType = document.getElementById('loan-modal-custom-type').value.trim();
            const reason = document.getElementById('loan-modal-reason').value.trim();
            const amount = document.getElementById('loan-modal-amount').value.trim();
            const interestRate = document.getElementById('loan-modal-interest').value.trim();
            const tenure = document.getElementById('loan-modal-tenure').value.trim();
            const firstEmiDate = document.getElementById('loan-modal-first-emi-date').value;
            
            let hasErrors = false;
            
            // Validate bank name
            if (!bankName) {
                showFieldError('loan-modal-bank', 'Bank name is required');
                hasErrors = true;
            }
            
            // Validate loan type
            if (!loanTypeSelect) {
                showFieldError('loan-modal-type', 'Loan type is required');
                hasErrors = true;
            }
            
            // Determine final loan type
            let loanType = loanTypeSelect;
            if (loanTypeSelect === 'Other') {
                if (!customLoanType) {
                    showFieldError('loan-modal-custom-type', 'Please specify the loan type');
                    hasErrors = true;
                } else {
                    loanType = customLoanType;
                }
            }
            
            // Validate amount
            if (!amount) {
                showFieldError('loan-modal-amount', 'Amount is required');
                hasErrors = true;
            } else if (parseFloat(amount) <= 0) {
                showFieldError('loan-modal-amount', 'Amount must be greater than 0');
                hasErrors = true;
            }
            
            // Validate interest rate
            if (!interestRate) {
                showFieldError('loan-modal-interest', 'Interest rate is required');
                hasErrors = true;
            } else if (parseFloat(interestRate) < 0) {
                showFieldError('loan-modal-interest', 'Interest rate cannot be negative');
                hasErrors = true;
            }
            
            // Validate tenure
            if (!tenure) {
                showFieldError('loan-modal-tenure', 'Tenure is required');
                hasErrors = true;
            } else if (parseInt(tenure) <= 0) {
                showFieldError('loan-modal-tenure', 'Tenure must be greater than 0');
                hasErrors = true;
            }
            
            // Validate first EMI date
            if (!firstEmiDate) {
                showFieldError('loan-modal-first-emi-date', 'First EMI date is required');
                hasErrors = true;
            }
            
            // If there are errors, stop here
            if (hasErrors) {
                return;
            }
            
            try {
                if (id) {
                    // Update existing
                    window.Loans.update(id, bankName, loanType, reason, amount, interestRate, tenure, firstEmiDate);
                    Utils.showSuccess('Loan updated!');
                } else {
                    // Add new
                    window.Loans.add(bankName, loanType, reason, amount, interestRate, tenure, firstEmiDate);
                    Utils.showSuccess('Loan added!');
                }
                
                window.Loans.render();
                closeLoanModal();
            } catch (error) {
                // Unexpected errors still show modal
                Utils.showError(error.message);
            }
        }
        
        window.applyCustomDateFilter = function() {
            if (!window.Expenses) return;
            
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            
            if (!startDate || !endDate) {
                Utils.showError('Please select both start and end dates');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                Utils.showError('Start date must be before end date');
                return;
            }
            
            Expenses.startDate = startDate;
            Expenses.endDate = endDate;
            Expenses.currentPage = 1;
            Expenses.render();
            
            const filterLabel = document.getElementById('date-filter-label');
            const filterLabelInfo = document.getElementById('date-filter-label-info');
            if (filterLabel) filterLabel.textContent = 'Custom Range';
            if (filterLabelInfo) filterLabelInfo.textContent = 'Custom Range';
            
            closeDateFilterModal();
        }
        
        function handleAddExpense() {
            try {
                const description = document.getElementById('expense-description').value.trim();
                const amount = document.getElementById('expense-amount').value.trim();
                const category = document.getElementById('expense-category').value;
                const date = document.getElementById('expense-date').value;
                
                Expenses.add(description, amount, category, date);
                Expenses.render();
                
                // Clear form and hide it
                document.getElementById('expense-description').value = '';
                document.getElementById('expense-amount').value = '';
                document.getElementById('expense-category').value = '';
                document.getElementById('expense-date').value = '';
                document.getElementById('expense-form').classList.add('hidden');
                
                Utils.showSuccess('Expense added successfully!');
            } catch (error) {
                Utils.showError(error.message);
            }
        }
        
        // Investment Modal Functions
        let currentUsdToInrRate = null;
        
        function openInvestmentModal() {
            document.getElementById('investment-modal').classList.remove('hidden');
            document.getElementById('investment-modal-title').textContent = 'Add Investment';
            document.getElementById('investment-modal-id').value = '';
            document.getElementById('investment-modal-name').value = '';
            document.getElementById('investment-modal-type').value = 'stock'; // Default to stock
            document.getElementById('investment-modal-term').value = '';
            document.getElementById('investment-modal-stock-price').value = '';
            document.getElementById('investment-modal-currency').value = 'INR';
            document.getElementById('investment-modal-quantity').value = '';
            document.getElementById('investment-modal-gold-price').value = '';
            document.getElementById('investment-modal-gold-grams').value = '';
            document.getElementById('investment-modal-amount').value = '';
            document.getElementById('investment-modal-other-type').value = '';
            document.getElementById('investment-modal-notes').value = '';
            document.getElementById('calculated-amount').textContent = '';
            document.getElementById('calculated-gold-amount').textContent = '';
            
            // Populate name autocomplete from existing investments
            const datalist = document.getElementById('investment-names-list');
            const existingNames = new Set();
            
            // Get names from portfolio
            if (window.DB.investments) {
                window.DB.investments.forEach(inv => existingNames.add(inv.name));
            }
            
            // Get names from monthly investments
            if (window.DB.monthlyInvestments) {
                window.DB.monthlyInvestments.forEach(inv => existingNames.add(inv.name));
            }
            
            // Populate datalist
            datalist.innerHTML = Array.from(existingNames)
                .sort()
                .map(name => `<option value="${name}">`)
                .join('');
            
            // Set default mode to Month and date to today
            document.getElementById('investment-mode-current').checked = true;
            document.getElementById('investment-mode-current').disabled = false;
            document.getElementById('investment-mode-existing').disabled = false;
            document.getElementById('investment-modal-date').value = new Date().toISOString().split('T')[0];
            toggleInvestmentMode();
            toggleInvestmentFields();
        }
        
        function closeInvestmentModal() {
            document.getElementById('investment-modal').classList.add('hidden');
        }
        
        // Temporary storage for Add/Override choice
        let pendingInvestmentData = null;
        
        function showAddOrOverrideChoice(existing, name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate) {
            console.log('ðŸŸ¡ showAddOrOverrideChoice called');
            console.log('ðŸ“¦ Storing pending data:', { existing, name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate });
            
            pendingInvestmentData = { existing, name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate };
            
            const modal = document.getElementById('add-override-choice-modal');
            const message = document.getElementById('add-override-message');
            
            console.log('ðŸŽ¯ Choice modal found:', modal ? 'Yes' : 'No');
            
            // Build existing value message with proper HTML formatting
            let existingInfo = `<p class="text-gray-800 mb-3"><strong>"${existing.name}"</strong> <span class="text-sm text-gray-600">(${term === 'long' ? 'Long Term' : 'Short Term'})</span> already exists with:</p>`;
            
            existingInfo += `<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">`;
            
            if (type === 'gold' && existing.quantity) {
                existingInfo += `<p class="text-sm text-gray-700 mb-1">â€¢ <strong>${existing.quantity} grams</strong></p>`;
                existingInfo += `<p class="text-sm text-gray-700">â€¢ Value: <strong>${Utils.formatCurrency(existing.amount)}</strong></p>`;
            } else if (type === 'stock' && existing.quantity) {
                existingInfo += `<p class="text-sm text-gray-700 mb-1">â€¢ <strong>${existing.quantity} shares</strong></p>`;
                existingInfo += `<p class="text-sm text-gray-700">â€¢ Value: <strong>${Utils.formatCurrency(existing.amount)}</strong></p>`;
            } else {
                existingInfo += `<p class="text-sm text-gray-700">â€¢ Amount: <strong>${Utils.formatCurrency(existing.amount)}</strong></p>`;
            }
            
            existingInfo += `</div>`;
            existingInfo += `<p class="text-gray-700 font-medium">What would you like to do?</p>`;
            message.innerHTML = existingInfo;
            
            // Setup button handlers using onclick for reliability
            const addBtn = document.getElementById('add-to-existing-btn');
            const overrideBtn = document.getElementById('override-existing-btn');
            const cancelBtn = document.getElementById('add-override-cancel-btn');
            
            console.log('ðŸ”˜ Choice buttons found - Add:', addBtn ? 'Yes' : 'No', ', Override:', overrideBtn ? 'Yes' : 'No', ', Cancel:', cancelBtn ? 'Yes' : 'No');
            
            if (addBtn) addBtn.onclick = function() {
                console.log('âž• Add to Existing clicked');
                handleAddToExisting();
            };
            
            if (overrideBtn) overrideBtn.onclick = function() {
                console.log('ðŸ”„ Override Existing clicked');
                handleOverrideExisting();
            };
            
            if (cancelBtn) cancelBtn.onclick = function() {
                console.log('ðŸš« Choice cancelled');
                closeAddOverrideChoiceModal();
            };
            
            modal.classList.remove('hidden');
            console.log('ðŸŽ­ Choice modal should now be visible');
        }
        
        function closeAddOverrideChoiceModal() {
            document.getElementById('add-override-choice-modal').classList.add('hidden');
            pendingInvestmentData = null;
        }
        
        function handleAddToExisting() {
            console.log('âž• handleAddToExisting called');
            
            if (!pendingInvestmentData) {
                console.error('âŒ No pending data');
                return;
            }
            
            const { existing, name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate } = pendingInvestmentData;
            
            // Find the actual investment in DB (in case existing object was serialized/deserialized)
            let actualExisting = existing;
            if (existing.id) {
                const foundInDB = window.DB.investments.find(inv => inv.id === existing.id);
                if (foundInDB) {
                    console.log('âœ… Found investment in DB by ID');
                    actualExisting = foundInDB;
                } else {
                    console.warn('âš ï¸ Could not find investment by ID, trying by name+type+term');
                    const foundByMatch = window.DB.investments.find(inv => 
                        inv.name.toLowerCase() === existing.name.toLowerCase() && 
                        inv.type === existing.type &&
                        inv.term === existing.term
                    );
                    if (foundByMatch) {
                        console.log('âœ… Found investment by name+type+term match');
                        actualExisting = foundByMatch;
                    }
                }
            }
            
            console.log('ðŸ“¦ Before adding:', { 
                name: actualExisting.name, 
                type: actualExisting.type, 
                quantity: actualExisting.quantity,
                amount: actualExisting.amount 
            });
            
            // Add to existing
            if (type === 'gold' && quantity) {
                // Add grams
                actualExisting.quantity = (actualExisting.quantity || 0) + quantity;
                // Recalculate amount
                if (window.DB.goldRatePerGram) {
                    actualExisting.amount = window.DB.goldRatePerGram * actualExisting.quantity;
                } else {
                    actualExisting.amount += amount;
                }
            } else if (type === 'stock' && quantity) {
                // Add shares and amounts
                console.log('âž• Adding shares:', quantity, 'to existing:', actualExisting.quantity);
                console.log('ðŸ’µ Adding amount:', amount, 'to existing:', actualExisting.amount);
                
                actualExisting.quantity = (actualExisting.quantity || 0) + quantity;
                actualExisting.amount += amount;
                
                console.log('âœ… After adding - Quantity:', actualExisting.quantity, ', Amount:', actualExisting.amount);
                console.log('â„¹ï¸ Use "Refresh Stocks" to update prices');
            } else {
                // Add amount
                actualExisting.amount += amount;
            }
            
            console.log('ðŸ“¦ After adding:', { 
                name: actualExisting.name, 
                type: actualExisting.type, 
                quantity: actualExisting.quantity,
                amount: actualExisting.amount 
            });
            
            actualExisting.lastUpdated = Utils.getCurrentTimestamp();
            
            console.log('ðŸ’¾ Saving to storage...');
            window.Storage.save();
            console.log('âœ… Saved successfully');
            
            console.log('ðŸ“Š Portfolio count:', window.DB.investments.length);
            console.log('ðŸ“Š Updated investment in DB:', window.DB.investments.find(i => i.id === actualExisting.id));
            
            closeAddOverrideChoiceModal();
            closeInvestmentModal();
            
            console.log('ðŸŽ¨ Re-rendering investments...');
            Investments.render();
            
            Utils.showSuccess('Added to existing investment successfully!');
            pendingInvestmentData = null;
            console.log('ðŸ handleAddToExisting completed');
        }
        
        function handleOverrideExisting() {
            console.log('ðŸ”µ handleOverrideExisting called');
            console.log('ðŸ” pendingInvestmentData status:', pendingInvestmentData);
            
            if (!pendingInvestmentData) {
                console.error('âŒ No pending investment data in handleOverrideExisting');
                return;
            }
            
            console.log('ðŸ“¦ Pending data:', JSON.stringify(pendingInvestmentData));
            
            const { existing, name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate} = pendingInvestmentData;
            
            // Store data on modal element to preserve it and show confirmation
            const modal = document.getElementById('override-confirm-modal');
            const message = document.getElementById('override-confirm-message');
            
            modal.dataset.pendingData = JSON.stringify(pendingInvestmentData);
            console.log('ðŸ’¾ Stored data on modal element');
            
            console.log('ðŸŽ¯ Modal found:', modal ? 'Yes' : 'No');
            console.log('ðŸ’¬ Message element found:', message ? 'Yes' : 'No');
            
            let confirmMsg = `<p class="text-gray-700 mb-4">This will <strong class="text-red-600">REPLACE</strong> the existing investment:</p>`;
            
            confirmMsg += `<div class="bg-red-50 border border-red-200 rounded-lg p-3 mb-3">`;
            confirmMsg += `<p class="text-sm font-semibold text-red-900 mb-2">Current Value:</p>`;
            
            if (type === 'gold' && existing.quantity) {
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${existing.quantity} grams</p>`;
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${Utils.formatCurrency(existing.amount)}</p>`;
            } else if (type === 'stock' && existing.quantity) {
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${existing.quantity} shares</p>`;
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${Utils.formatCurrency(existing.amount)}</p>`;
            } else {
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${Utils.formatCurrency(existing.amount)}</p>`;
            }
            confirmMsg += `</div>`;
            
            confirmMsg += `<div class="bg-green-50 border border-green-200 rounded-lg p-3">`;
            confirmMsg += `<p class="text-sm font-semibold text-green-900 mb-2">New Value:</p>`;
            if (type === 'gold' && quantity) {
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${quantity} grams</p>`;
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${Utils.formatCurrency(amount)}</p>`;
            } else if (type === 'stock' && quantity) {
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${quantity} shares</p>`;
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${Utils.formatCurrency(amount)}</p>`;
            } else {
                confirmMsg += `<p class="text-sm text-gray-700">â€¢ ${Utils.formatCurrency(amount)}</p>`;
            }
            confirmMsg += `</div>`;
            
            message.innerHTML = confirmMsg;
            
            // Setup button handlers using onclick
            const proceedBtn = document.getElementById('override-proceed-btn');
            const cancelBtn = document.getElementById('override-cancel-btn');
            
            console.log('ðŸ”˜ Proceed button found:', proceedBtn ? 'Yes' : 'No');
            console.log('ðŸ”˜ Cancel button found:', cancelBtn ? 'Yes' : 'No');
            
            if (proceedBtn) {
                proceedBtn.onclick = function() {
                    console.log('âœ… Override proceed button CLICKED!');
                    processOverride();
                };
                console.log('âœ… onclick assigned to proceed button');
            } else {
                console.error('âŒ Could not find override-proceed-btn');
            }
            
            if (cancelBtn) {
                cancelBtn.onclick = function() {
                    console.log('ðŸš« Override cancelled');
                    closeOverrideConfirmModal();
                };
                console.log('âœ… onclick assigned to cancel button');
            }
            
            closeAddOverrideChoiceModal();
            modal.classList.remove('hidden');
            console.log('ðŸŽ­ Override modal should now be visible');
        }
        
        function closeOverrideConfirmModal() {
            document.getElementById('override-confirm-modal').classList.add('hidden');
        }
        
        function processOverride() {
            console.log('ðŸŸ¢ processOverride called!');
            console.log('ðŸ” pendingInvestmentData (global):', pendingInvestmentData);
            
            // Try to get data from modal element first
            const modal = document.getElementById('override-confirm-modal');
            let data = null;
            
            if (modal && modal.dataset.pendingData) {
                console.log('ðŸ“¦ Found data on modal element');
                data = JSON.parse(modal.dataset.pendingData);
            } else if (pendingInvestmentData) {
                console.log('ðŸ“¦ Using global pendingInvestmentData');
                data = pendingInvestmentData;
            } else {
                console.error('âŒ No pending investment data in processOverride - neither on modal nor global');
                Utils.showError('Error: No investment data found');
                return;
            }
            
            console.log('ðŸ“¦ Processing override with data:', data);
            
            const { existing, name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate } = data;
            
            // Find the actual investment in DB (in case existing object was serialized/deserialized)
            let actualExisting = existing;
            if (existing.id) {
                const foundInDB = window.DB.investments.find(inv => inv.id === existing.id);
                if (foundInDB) {
                    console.log('âœ… Found investment in DB by ID');
                    actualExisting = foundInDB;
                } else {
                    console.warn('âš ï¸ Could not find investment by ID, using parsed object');
                }
            }
            
            console.log('ðŸ”„ Investment before override:', JSON.parse(JSON.stringify(actualExisting)));
            
            // Override existing values
            actualExisting.name = name;
            actualExisting.amount = amount;
            actualExisting.term = term;
            actualExisting.type = type;
            actualExisting.quantity = quantity;
            actualExisting.notes = notes;
            actualExisting.inputStockPrice = stockPrice;
            actualExisting.inputCurrency = currency;
            actualExisting.usdToInrRate = usdToInrRate;
            actualExisting.lastUpdated = Utils.getCurrentTimestamp();
            
            console.log('ðŸ”„ Investment after override:', JSON.parse(JSON.stringify(actualExisting)));
            
            console.log('ðŸ’¾ Saving to storage...');
            window.Storage.save();
            console.log('âœ… Saved to storage');
            
            console.log('ðŸ“Š Portfolio after override, before render:');
            console.log('  Total investments:', window.DB.investments.length);
            console.log('  Investments:', window.DB.investments.map(inv => ({ 
                id: inv.id, 
                name: inv.name, 
                type: inv.type, 
                quantity: inv.quantity 
            })));
            
            console.log('ðŸšª Closing modals...');
            closeOverrideConfirmModal();
            closeInvestmentModal();
            
            console.log('ðŸŽ¨ Re-rendering investments...');
            Investments.render();
            
            console.log('ðŸ“Š Portfolio after render:');
            console.log('  Total investments:', window.DB.investments.length);
            console.log('  Investments:', window.DB.investments.map(inv => ({ 
                id: inv.id, 
                name: inv.name, 
                type: inv.type, 
                quantity: inv.quantity 
            })));
            
            console.log('âœ… Showing success toast');
            Utils.showSuccess('Investment overridden successfully!');
            
            // Clean up
            if (modal) {
                delete modal.dataset.pendingData;
            }
            pendingInvestmentData = null;
            console.log('ðŸ§¹ Cleaned up pending data');
            console.log('ðŸ processOverride completed');
        }
        
        function toggleInvestmentMode() {
            const isCurrent = document.getElementById('investment-mode-current').checked;
            const dateField = document.getElementById('investment-date-field');
            
            if (isCurrent) {
                dateField.classList.remove('hidden');
            } else {
                dateField.classList.add('hidden');
            }
        }
        
        function toggleInvestmentFields() {
            const type = document.getElementById('investment-modal-type').value;
            const stockFields = document.getElementById('stock-fields');
            const goldFields = document.getElementById('gold-fields');
            const amountField = document.getElementById('amount-field');
            const otherTypeField = document.getElementById('other-type-field');
            const priceLabel = document.getElementById('stock-price-label');
            
            // Hide all first
            stockFields.classList.add('hidden');
            goldFields.classList.add('hidden');
            amountField.classList.add('hidden');
            otherTypeField.classList.add('hidden');
            
            if (type === 'stock') {
                priceLabel.textContent = 'Price per Share';
                stockFields.classList.remove('hidden');
            } else if (type === 'mutual_fund') {
                priceLabel.textContent = 'NAV / Unit Price';
                stockFields.classList.remove('hidden');
            } else if (type === 'gold') {
                goldFields.classList.remove('hidden');
                // Pre-populate gold rate if available
                const goldPriceInput = document.getElementById('investment-modal-gold-price');
                if (window.DB.goldRatePerGram && !goldPriceInput.value) {
                    goldPriceInput.value = window.DB.goldRatePerGram;
                    calculateGoldAmount(); // Trigger calculation if grams already entered
                }
            } else if (type === 'other') {
                otherTypeField.classList.remove('hidden');
                amountField.classList.remove('hidden');
            } else {
                amountField.classList.remove('hidden');
            }
        }
        
        function calculateGoldAmount() {
            const pricePerGram = parseFloat(document.getElementById('investment-modal-gold-price').value) || 0;
            const grams = parseFloat(document.getElementById('investment-modal-gold-grams').value) || 0;
            
            if (pricePerGram > 0 && grams > 0) {
                const totalAmount = pricePerGram * grams;
                document.getElementById('calculated-gold-amount').textContent = 
                    `â‚¹${pricePerGram}/gram Ã— ${grams}g = Total: â‚¹${totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            } else {
                document.getElementById('calculated-gold-amount').textContent = '';
            }
        }
        
        function showInvestmentModeTooltip(event, mode) {
            event.preventDefault();
            event.stopPropagation();
            
            const tooltips = {
                'month': 'Track monthly additions to your investments. Each entry is recorded with a date for tracking your investment journey.',
                'portfolio': 'Update your cumulative portfolio value. This represents your current total holdings.'
            };
            
            Utils.showSuccess(tooltips[mode] || 'Investment mode');
        }
        
        async function getUsdToInrRate() {
            // Try to use cached rate from last 1 hour
            if (currentUsdToInrRate && currentUsdToInrRate.timestamp && 
                (Date.now() - currentUsdToInrRate.timestamp) < 3600000) {
                return currentUsdToInrRate.rate;
            }
            
            try {
                // Fetch current rate using AI
                if (!window.AIProvider || !window.AIProvider.isConfigured()) {
                    return 83; // Fallback rate
                }
                
                const response = await window.AIProvider.call(
                    'What is the current USD to INR exchange rate? Return ONLY the number, no explanations.',
                    { system_instruction: 'You are a currency converter. Return only the numeric exchange rate.' }
                );
                
                const rate = parseFloat(response.match(/[\d.]+/)?.[0] || 83);
                currentUsdToInrRate = { rate, timestamp: Date.now() };
                return rate;
            } catch (error) {
                console.error('Failed to fetch USD to INR rate:', error);
                return 83; // Fallback rate
            }
        }
        
        async function calculateStockAmount() {
            const price = parseFloat(document.getElementById('investment-modal-stock-price').value) || 0;
            const quantity = parseFloat(document.getElementById('investment-modal-quantity').value) || 0;
            const currency = document.getElementById('investment-modal-currency').value;
            
            if (price > 0 && quantity > 0) {
                let priceInInr = price;
                let displayText = '';
                
                if (currency === 'USD') {
                    // Use global exchange rate from DB
                    const rate = window.DB.exchangeRate?.rate || 83;
                    priceInInr = price * rate;
                    displayText = `Price: â‚¹${priceInInr.toFixed(2)}/share (USD ${price} Ã— â‚¹${rate.toFixed(2)}) | `;
                    
                    if (!window.DB.exchangeRate || !window.DB.exchangeRate.rate) {
                        displayText += `âš ï¸ Using default rate (â‚¹83). Update rate in Investments page | `;
                    }
                } else {
                    displayText = `Price: â‚¹${price}/share | `;
                }
                
                const totalAmount = priceInInr * quantity;
                displayText += `Total: â‚¹${totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                document.getElementById('calculated-amount').textContent = displayText;
            } else {
                document.getElementById('calculated-amount').textContent = '';
            }
        }
        
        async function saveInvestmentModal() {
            try {
                const id = document.getElementById('investment-modal-id').value;
                let name = document.getElementById('investment-modal-name').value.trim();
                let type = document.getElementById('investment-modal-type').value;
                const term = document.getElementById('investment-modal-term').value;
                const notes = document.getElementById('investment-modal-notes').value.trim();
                const mode = document.getElementById('investment-mode-current').checked ? 'current' : 'existing';
                const date = mode === 'current' ? document.getElementById('investment-modal-date').value : null;
                
                let amount, quantity, stockPrice, currency, usdToInrRate;
                
                // Handle "other" type
                if (type === 'other') {
                    const customType = document.getElementById('investment-modal-other-type').value.trim();
                    if (!customType) {
                        throw new Error('Please specify the investment type');
                    }
                    name = name + ' (' + customType + ')';
                }
                
                if (type === 'stock' || type === 'mutual_fund') {
                    stockPrice = parseFloat(document.getElementById('investment-modal-stock-price').value) || 0;
                    quantity = parseFloat(document.getElementById('investment-modal-quantity').value) || 0;
                    currency = document.getElementById('investment-modal-currency').value;
                    
                    if (!stockPrice || !quantity) {
                        throw new Error('Please enter price and quantity');
                    }
                    
                    // Convert to INR if USD
                    if (currency === 'USD') {
                        usdToInrRate = await getUsdToInrRate();
                        const priceInInr = stockPrice * usdToInrRate;
                        amount = priceInInr * quantity;
                    } else {
                        amount = stockPrice * quantity;
                    }
                } else if (type === 'gold') {
                    stockPrice = parseFloat(document.getElementById('investment-modal-gold-price').value) || 0;
                    quantity = parseFloat(document.getElementById('investment-modal-gold-grams').value) || 0;
                    
                    if (!stockPrice || !quantity) {
                        throw new Error('Please enter price per gram and grams');
                    }
                    
                    amount = stockPrice * quantity;
                    currency = 'INR';
                } else {
                    amount = parseFloat(document.getElementById('investment-modal-amount').value) || 0;
                    if (!amount) {
                        throw new Error('Please enter amount');
                    }
                }
                
                // Validate date for current investments
                if (mode === 'current' && !date) {
                    throw new Error('Please select investment date');
                }
                
                if (mode === 'current') {
                    // Check if editing or adding monthly investment
                    if (id) {
                        // Update existing monthly investment
                        Investments.updateMonthlyInvestment(id, name, amount, date, term, type, quantity, notes, stockPrice, currency, usdToInrRate);
                        Utils.showSuccess('Monthly investment updated successfully!');
                    } else {
                        // Add to monthly investments
                        Investments.addMonthlyInvestment(name, amount, date, term, type, quantity, notes, stockPrice, currency, usdToInrRate);
                        Utils.showSuccess('Monthly investment added successfully!');
                    }
                } else {
                    // Check if editing or adding to existing portfolio
                    if (id) {
                        // Update existing investment
                        Investments.update(id, name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate);
                        Utils.showSuccess('Investment updated successfully!');
                    } else {
                        // Check if an entry with same name+type+term exists
                        console.log('ðŸ” Checking for existing investment:');
                        console.log('  Looking for:', { name: name.toLowerCase(), type, term });
                        console.log('  In portfolio:', window.DB.investments.map(inv => ({ 
                            name: inv.name.toLowerCase(), 
                            type: inv.type, 
                            term: inv.term 
                        })));
                        
                        const existing = window.DB.investments.find(inv => 
                            inv.name.toLowerCase() === name.toLowerCase() && 
                            inv.type === type &&
                            inv.term === term
                        );
                        
                        console.log('  Found existing:', existing ? 'Yes' : 'No');
                        
                        if (existing) {
                            console.log('  Showing Add/Override modal');
                            // Show Add/Override choice modal
                            showAddOrOverrideChoice(existing, name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate);
                        } else {
                            console.log('  Adding as new investment');
                            // Add new investment
                            Investments.add(name, amount, term, type, quantity, notes, stockPrice, currency, usdToInrRate);
                            Utils.showSuccess('Investment added successfully!');
                            Investments.render();
                            closeInvestmentModal();
                        }
                        return; // Exit if showing modal or adding new
                    }
                }
                
                // Only render and close for update and monthly investments
                Investments.render();
                closeInvestmentModal();
            } catch (error) {
                Utils.showError(error.message);
            }
        }
        
        // Credential Modal Functions
        let currentCredentialId = null;
        let currentViewPasswordVisible = false;
        let currentViewPassword = '';
        
        // Make viewCredential globally accessible
        window.viewCredential = function(id) {
            if (!window.DB?.credentials || window.DB.credentials.length === 0) {
                Utils.showError('No credentials found. Please add a credential first.');
                return;
            }
            
            const cred = window.DB.credentials.find(c => c.id === id);
            
            if (!cred) {
                Utils.showError('Credential not found');
                return;
            }
            
            currentCredentialId = id;
            currentViewPassword = cred.password;
            currentViewPasswordVisible = false;
            
            const modal = document.getElementById('credential-view-modal');
            if (!modal) {
                console.error('credential-view-modal not found');
                Utils.showError('View modal not found');
                return;
            }
            
            modal.classList.remove('hidden');
            document.getElementById('view-service').textContent = cred.service;
            document.getElementById('view-username').textContent = cred.username;
            document.getElementById('view-password').textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            
            if (cred.tag) {
                document.getElementById('view-tag').textContent = cred.tag;
                document.getElementById('view-tag-container').classList.remove('hidden');
            } else {
                document.getElementById('view-tag-container').classList.add('hidden');
            }
            
            const description = cred.description || cred.notes || '';
            if (description) {
                document.getElementById('view-description').textContent = description;
                document.getElementById('view-description-container').classList.remove('hidden');
            } else {
                document.getElementById('view-description-container').classList.add('hidden');
            }
            
            if (cred.additionalDetails) {
                document.getElementById('view-additional-details').textContent = cred.additionalDetails;
                document.getElementById('view-additional-details-container').classList.remove('hidden');
            } else {
                document.getElementById('view-additional-details-container').classList.add('hidden');
            }
            
        };
        
        window.openCredentialModal = function(id = null) {
            // Always clear fields first
            document.getElementById('credential-modal-title').textContent = 'Add Credential';
            document.getElementById('credential-modal-id').value = '';
            document.getElementById('credential-modal-service').value = '';
            document.getElementById('credential-modal-tag').value = '';
            document.getElementById('credential-modal-username').value = '';
            document.getElementById('credential-modal-password').value = '';
            document.getElementById('credential-modal-description').value = '';
            document.getElementById('credential-modal-additional-details').value = '';
            
            if (id) {
                // Edit mode - populate with existing data
                // Convert both to string for type-safe comparison
                const searchId = String(id);
                const cred = window.DB.credentials.find(c => String(c.id) === searchId);
                
                if (cred) {
                    document.getElementById('credential-modal-title').textContent = 'Edit Credential';
                    document.getElementById('credential-modal-id').value = cred.id;
                    document.getElementById('credential-modal-service').value = cred.service;
                    document.getElementById('credential-modal-tag').value = cred.tag || '';
                    document.getElementById('credential-modal-username').value = cred.username;
                    document.getElementById('credential-modal-password').value = cred.password;
                    document.getElementById('credential-modal-description').value = cred.description || cred.notes || '';
                    document.getElementById('credential-modal-additional-details').value = cred.additionalDetails || '';
                } else {
                    Utils.showError('Credential not found');
                    return;
                }
            }
            
            document.getElementById('credential-modal').classList.remove('hidden');
        };
        
        window.closeCredentialModal = function() {
            clearAllFormErrors('credential-modal');
            document.getElementById('credential-modal').classList.add('hidden');
        };
        
        window.saveCredentialModal = function() {
            // Clear all previous errors
            clearAllFormErrors('credential-modal');
            
            const id = document.getElementById('credential-modal-id').value;
            const service = document.getElementById('credential-modal-service').value.trim();
            const tag = document.getElementById('credential-modal-tag').value.trim();
            const username = document.getElementById('credential-modal-username').value.trim();
            const password = document.getElementById('credential-modal-password').value.trim();
            const description = document.getElementById('credential-modal-description').value.trim();
            const additionalDetails = document.getElementById('credential-modal-additional-details').value.trim();
            
            let hasErrors = false;
            
            // Validate service
            if (!service) {
                showFieldError('credential-modal-service', 'Service name is required');
                hasErrors = true;
            }
            
            // Validate username
            if (!username) {
                showFieldError('credential-modal-username', 'Username is required');
                hasErrors = true;
            }
            
            // Validate password
            if (!password) {
                showFieldError('credential-modal-password', 'Password is required');
                hasErrors = true;
            }
            
            // If there are errors, stop here
            if (hasErrors) {
                return;
            }
            
            try {
                if (id) {
                    // Update existing
                    Credentials.update(id, service, username, password, description, additionalDetails, tag);
                    Utils.showSuccess('Credential updated!');
                } else {
                    // Add new
                    Credentials.add(service, username, password, description, additionalDetails, tag);
                    Utils.showSuccess('Credential added!');
                }
                
                Credentials.render();
                closeCredentialModal();
            } catch (error) {
                // Unexpected errors still show modal
                Utils.showError(error.message);
            }
        }
        
        
        window.closeCredentialViewModal = function() {
            document.getElementById('credential-view-modal').classList.add('hidden');
            currentCredentialId = null;
            currentViewPassword = '';
            currentViewPasswordVisible = false;
        };
        
        window.toggleViewPassword = function() {
            currentViewPasswordVisible = !currentViewPasswordVisible;
            const passwordEl = document.getElementById('view-password');
            
            if (currentViewPasswordVisible) {
                passwordEl.textContent = currentViewPassword;
            } else {
                passwordEl.textContent = 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢';
            }
        }
        
        window.editCredentialFromView = function() {
            window.closeCredentialViewModal();
            window.openCredentialModal(currentCredentialId);
        };
        
        // Investment Edit Modal
        function openInvestmentEditModal(id) {
            console.log('ðŸ“ Opening edit modal for ID:', id);
            
            // Handle both string and number IDs
            const inv = window.DB.investments.find(i => i.id == id || String(i.id) === String(id));
            if (!inv) {
                console.error('âŒ Investment not found');
                Utils.showError('Investment not found');
                return;
            }
            
            console.log('ðŸ“¦ Editing investment:', inv);
            
            document.getElementById('investment-modal').classList.remove('hidden');
            document.getElementById('investment-modal-title').textContent = 'Edit Investment';
            document.getElementById('investment-modal-id').value = String(inv.id);
            document.getElementById('investment-modal-name').value = inv.name;
            document.getElementById('investment-modal-type').value = inv.type;
            document.getElementById('investment-modal-term').value = inv.term;
            document.getElementById('investment-modal-notes').value = inv.notes || '';
            
            // Set mode to Portfolio (existing) and lock it
            document.getElementById('investment-mode-existing').checked = true;
            document.getElementById('investment-mode-current').disabled = true;
            document.getElementById('investment-mode-existing').disabled = true;
            toggleInvestmentMode();
            
            // Clear all fields first
            document.getElementById('investment-modal-stock-price').value = '';
            document.getElementById('investment-modal-currency').value = 'INR';
            document.getElementById('investment-modal-quantity').value = '';
            document.getElementById('investment-modal-gold-price').value = '';
            document.getElementById('investment-modal-gold-grams').value = '';
            document.getElementById('investment-modal-amount').value = '';
            
            // Fill fields based on type
            if (inv.type === 'stock' || inv.type === 'mutual_fund') {
                document.getElementById('investment-modal-stock-price').value = inv.inputStockPrice || '';
                document.getElementById('investment-modal-currency').value = inv.inputCurrency || 'INR';
                document.getElementById('investment-modal-quantity').value = inv.quantity || '';
            } else if (inv.type === 'gold') {
                document.getElementById('investment-modal-gold-price').value = inv.inputStockPrice || '';
                document.getElementById('investment-modal-gold-grams').value = inv.quantity || '';
            } else {
                document.getElementById('investment-modal-amount').value = inv.amount || '';
            }
            
            console.log('ðŸ”„ Toggling fields for type:', inv.type);
            toggleInvestmentFields();
            
            if (inv.type === 'stock' || inv.type === 'mutual_fund') {
                calculateStockAmount();
            } else if (inv.type === 'gold') {
                calculateGoldAmount();
            }
            
            console.log('âœ… Edit modal opened successfully');
        }
        
        // Exchange Rate Modal Functions
        function openExchangeRateModal() {
            const modal = document.getElementById('exchange-rate-modal');
            const input = document.getElementById('exchange-rate-input');
            const displayRate = document.getElementById('current-rate-display');
            const lastUpdated = document.getElementById('rate-last-updated');
            
            // Display current rate
            const currentRate = window.DB.exchangeRate?.rate || 83;
            displayRate.textContent = `â‚¹${currentRate.toFixed(2)}`;
            
            // Display last updated
            if (window.DB.exchangeRate?.lastUpdated) {
                const date = new Date(window.DB.exchangeRate.lastUpdated);
                lastUpdated.textContent = date.toLocaleString();
            } else {
                lastUpdated.textContent = 'Never';
            }
            
            // Set input value
            input.value = currentRate.toFixed(2);
            
            modal.classList.remove('hidden');
        }
        
        function closeExchangeRateModal() {
            document.getElementById('exchange-rate-modal').classList.add('hidden');
        }
        
        async function saveExchangeRate() {
            try {
                const input = document.getElementById('exchange-rate-input');
                const newRate = parseFloat(input.value);
                
                if (!newRate || isNaN(newRate) || newRate <= 0) {
                    Utils.showError('Please enter a valid exchange rate');
                    return;
                }
                
                closeExchangeRateModal();
                Loading.show('Updating exchange rate...');
                
                // Update in database
                window.DB.exchangeRate = {
                    rate: newRate,
                    lastUpdated: new Date().toISOString()
                };
                
                // Recalculate all USD stocks
                const updatedCount = Investments.recalculateUSDStocks(newRate);
                
                // Save to storage
                window.Storage.save();
                
                // Re-render to show updated values
                Investments.render();
                
                Loading.hide();
                
                if (updatedCount > 0) {
                    Utils.showSuccess(`Rate updated to â‚¹${newRate}. ${updatedCount} USD stock(s) recalculated.`);
                } else {
                    Utils.showSuccess(`Rate updated to â‚¹${newRate}`);
                }
            } catch (error) {
                Loading.hide();
                Utils.showError(error.message || 'Failed to update exchange rate');
            }
        }
        
        // Make exchange rate modal functions globally accessible
        window.openExchangeRateModal = openExchangeRateModal;
        window.closeExchangeRateModal = closeExchangeRateModal;
        window.saveExchangeRate = saveExchangeRate;
        
        // Edit Stock Price Modal Functions
        function openEditStockPriceModal(id) {
            const stock = window.DB.investments.find(inv => inv.id == id);
            if (!stock || stock.type !== 'stock') {
                Utils.showError('Stock not found');
                return;
            }
            
            const modal = document.getElementById('edit-stock-price-modal');
            const titleEl = document.getElementById('edit-stock-name-title');
            const idInput = document.getElementById('edit-stock-id');
            const priceInput = document.getElementById('edit-stock-price-input');
            const currencyInput = document.getElementById('edit-stock-currency-input');
            const quantityInput = document.getElementById('edit-stock-quantity-input');
            const currentPriceDisplay = document.getElementById('current-stock-price-display');
            
            // Set title
            titleEl.textContent = `Edit ${stock.name}`;
            
            // Set hidden ID
            idInput.value = stock.id;
            
            // Display current price
            if (stock.inputStockPrice) {
                const currencySymbol = stock.inputCurrency === 'USD' ? '$' : 'â‚¹';
                currentPriceDisplay.textContent = `${currencySymbol}${stock.inputStockPrice.toFixed(2)}`;
            } else {
                currentPriceDisplay.textContent = 'Not set';
            }
            
            // Set inputs
            priceInput.value = stock.inputStockPrice || '';
            currencyInput.value = stock.inputCurrency || 'INR';
            quantityInput.value = stock.quantity || '';
            
            modal.classList.remove('hidden');
        }
        
        function closeEditStockPriceModal() {
            document.getElementById('edit-stock-price-modal').classList.add('hidden');
        }
        
        async function saveEditStockPrice() {
            try {
                const id = document.getElementById('edit-stock-id').value;
                const price = parseFloat(document.getElementById('edit-stock-price-input').value);
                const currency = document.getElementById('edit-stock-currency-input').value;
                const quantity = parseFloat(document.getElementById('edit-stock-quantity-input').value);
                
                if (!price || isNaN(price) || price <= 0) {
                    Utils.showError('Please enter a valid price');
                    return;
                }
                
                if (!quantity || isNaN(quantity) || quantity <= 0) {
                    Utils.showError('Please enter a valid quantity');
                    return;
                }
                
                closeEditStockPriceModal();
                Loading.show('Updating stock price...');
                
                await Investments.editStockPrice(id, price, currency, quantity);
                
                Loading.hide();
                Utils.showSuccess('Stock price updated successfully');
            } catch (error) {
                Loading.hide();
                Utils.showError(error.message || 'Failed to update stock price');
            }
        }
        
        // Make edit stock price modal functions globally accessible
        window.openEditStockPriceModal = openEditStockPriceModal;
        window.closeEditStockPriceModal = closeEditStockPriceModal;
        window.saveEditStockPrice = saveEditStockPrice;
        
        // Legacy function for backwards compatibility
        async function updateUsdToInrRate() {
            openExchangeRateModal();
        }
        
        // ============================================
        // SECURITY FUNCTIONS
        // ============================================
        
        /**
         * Check if biometric is available and show option
         */
        async function checkBiometricAvailability() {
            const available = await window.Security.isBiometricAvailable();
            if (available) {
                // Show biometric setup option
                document.getElementById('biometric-setup-option').classList.remove('hidden');
                
                // Show biometric unlock button ONLY if biometric is enabled by user
                if (window.DB.security && window.DB.security.biometricEnabled) {
                    document.getElementById('biometric-unlock-btn').classList.remove('hidden');
                }
            }
        }
        
        /**
         * Open Change PIN modal
         */
        function openChangePinModal() {
            // Close settings modal
            document.getElementById('settings-modal').classList.add('hidden');
            
            // Clear inputs
            document.getElementById('change-current-pin').value = '';
            document.getElementById('change-new-pin').value = '';
            document.getElementById('change-confirm-pin').value = '';
            
            // Show change PIN modal
            document.getElementById('change-pin-modal').classList.remove('hidden');
        }
        
        /**
         * Close Change PIN modal
         */
        function closeChangePinModal() {
            document.getElementById('change-pin-modal').classList.add('hidden');
            
            // Reopen settings modal
            document.getElementById('settings-modal').classList.remove('hidden');
        }
        
        /**
         * Change PIN
         */
        async function changePin() {
            const currentPin = document.getElementById('change-current-pin').value;
            const newPin = document.getElementById('change-new-pin').value;
            const confirmPin = document.getElementById('change-confirm-pin').value;
            
            // Validate inputs
            if (!currentPin || currentPin.length !== 4) {
                window.Utils.showError('Please enter your current 4-digit PIN');
                return;
            }
            
            if (!newPin || newPin.length !== 4) {
                window.Utils.showError('New PIN must be exactly 4 digits');
                return;
            }
            
            if (newPin !== confirmPin) {
                window.Utils.showError('New PIN and confirmation do not match');
                return;
            }
            
            if (currentPin === newPin) {
                window.Utils.showError('New PIN must be different from current PIN');
                return;
            }
            
            try {
                if (window.Loading) {
                    window.Loading.show('Changing PIN...');
                }
                
                // Verify current PIN and change to new PIN
                await window.Security.changePin(currentPin, newPin);
                
                if (window.Loading) {
                    window.Loading.hide();
                }
                
                // Close modal
                closeChangePinModal();
                
                window.Utils.showSuccess('âœ… PIN changed successfully!');
                
                // Clear inputs
                document.getElementById('change-current-pin').value = '';
                document.getElementById('change-new-pin').value = '';
                document.getElementById('change-confirm-pin').value = '';
                
            } catch (error) {
                if (window.Loading) {
                    window.Loading.hide();
                }
                
                window.Utils.showError('âŒ ' + error.message);
                console.error('Change PIN failed:', error);
            }
        }
        
        /**
         * Handle PIN input with auto-focus on next field
         */
        function handlePinInput(currentId, nextId) {
            const input = document.getElementById(currentId);
            if (input.value.length === 4) {
                // Auto-focus to confirm field
                document.getElementById(nextId).focus();
            }
        }
        
        /**
         * Handle confirm PIN input with auto-submit
         */
        function handlePinConfirmInput() {
            const confirmInput = document.getElementById('setup-pin-confirm');
            if (confirmInput.value.length === 4) {
                // Auto-submit after 4 digits
                setTimeout(() => setupSecurity(), 100);
            }
        }
        
        /**
         * Toggle password visibility for any password field
         */
        async function togglePasswordVisibility(fieldId) {
            const input = document.getElementById(fieldId);
            const eyeIcon = document.getElementById(fieldId + '-eye');
            
            if (!input || !eyeIcon) return;
            
            // Special handling for master password - require authentication
            if (fieldId === 'master-password' && input.type === 'password') {
                // Try to authenticate before revealing master password
                const authenticated = await authenticateForMasterPassword();
                if (!authenticated) {
                    return;
                }
            }
            
            // Toggle input type
            if (input.type === 'password') {
                input.type = 'text';
                // Change to "eye-slash" icon (visible password)
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>
                `;
            } else {
                input.type = 'password';
                // Change back to "eye" icon (hidden password)
                eyeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                `;
            }
        }
        
        /**
         * Authenticate user before revealing master password (reuses existing auth system)
         */
        async function authenticateForMasterPassword() {
            // Check if biometric is enabled and available
            if (window.DB.security.biometricEnabled && window.Security) {
                try {
                    Loading.show('Authenticating...');
                    const success = await window.Security.authenticateWithBiometric();
                    Loading.hide();
                    
                    if (success) {
                        return true;
                    }
                } catch (error) {
                    Loading.hide();
                    // Fallback to PIN if biometric fails/cancelled
                }
            }
            
            // Fallback to PIN authentication
            if (window.DB.security.pinHash) {
                return new Promise((resolve) => {
                    // Create a simple PIN prompt modal
                    const modalHTML = `
                        <div id="master-password-auth-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[80] flex items-center justify-center p-4">
                            <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full">
                                <h3 class="text-xl font-bold mb-4 text-gray-800">ðŸ” Authentication Required</h3>
                                <p class="text-gray-600 mb-4">Enter your PIN to view Master Password</p>
                                <input type="password" id="master-password-auth-pin" inputmode="numeric" maxlength="4" 
                                       placeholder="Enter 4-digit PIN" 
                                       class="w-full px-4 py-3 border-2 border-purple-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-center text-2xl tracking-widest font-bold mb-4"
                                       autofocus>
                                <div class="flex gap-2">
                                    <button onclick="verifyMasterPasswordAuth()" class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg hover:shadow-lg transition-all duration-200 font-semibold">
                                        Verify
                                    </button>
                                    <button onclick="cancelMasterPasswordAuth()" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 font-semibold">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHTML);
                    
                    // Store resolver
                    window._masterPasswordAuthResolver = resolve;
                    
                    // Auto-submit on 4 digits
                    document.getElementById('master-password-auth-pin').addEventListener('input', function(e) {
                        if (e.target.value.length === 4) {
                            setTimeout(() => verifyMasterPasswordAuth(), 100);
                        }
                    });
                });
            }
            
            // No authentication set up
            return true;
        }
        
        /**
         * Verify PIN for master password authentication (reuses existing Security.unlockWithPin)
         */
        async function verifyMasterPasswordAuth() {
            const pin = document.getElementById('master-password-auth-pin').value;
            
            if (!pin || pin.length !== 4) {
                Utils.showError('Please enter a 4-digit PIN');
                return;
            }
            
            try {
                Loading.show('Verifying...');
                
                // Use existing Security.unlockWithPin method
                const success = await window.Security.unlockWithPin(pin);
                
                Loading.hide();
                
                if (success) {
                    // Success - close modal and resolve
                    const modal = document.getElementById('master-password-auth-modal');
                    if (modal) modal.remove();
                    
                    if (window._masterPasswordAuthResolver) {
                        window._masterPasswordAuthResolver(true);
                        delete window._masterPasswordAuthResolver;
                    }
                } else {
                    // Wrong PIN
                    Utils.showError('Incorrect PIN. Please try again.');
                    document.getElementById('master-password-auth-pin').value = '';
                    document.getElementById('master-password-auth-pin').focus();
                }
            } catch (error) {
                Loading.hide();
                Utils.showError('Authentication failed');
                document.getElementById('master-password-auth-pin').value = '';
                document.getElementById('master-password-auth-pin').focus();
            }
        }
        
        /**
         * Cancel master password authentication
         */
        function cancelMasterPasswordAuth() {
            const modal = document.getElementById('master-password-auth-modal');
            if (modal) modal.remove();
            
            if (window._masterPasswordAuthResolver) {
                window._masterPasswordAuthResolver(false);
                delete window._masterPasswordAuthResolver;
            }
        }
        
        /**
         * Handle unlock PIN input with auto-submit
         */
        function handleUnlockPinInput() {
            const input = document.getElementById('unlock-pin');
            if (input.value.length === 4) {
                // Auto-submit after 4 digits
                setTimeout(() => unlockWithPin(), 100);
            }
        }
        
        /**
         * Setup security (PIN + optional biometric)
         */
        async function setupSecurity() {
            try {
                const pin = document.getElementById('setup-pin').value;
                const confirmPin = document.getElementById('setup-pin-confirm').value;
                const enableBiometric = document.getElementById('enable-biometric-checkbox').checked;
                
                if (!pin || pin.length !== 4) {
                    Utils.showError('PIN must be exactly 4 digits');
                    return;
                }
                
                if (pin !== confirmPin) {
                    Utils.showError('PINs do not match');
                    return;
                }
                
                Loading.show('Setting up security...');
                
                // Setup PIN
                await window.Security.setupPin(pin);
                
                // Enable biometric if requested
                if (enableBiometric) {
                    try {
                        await window.Security.enableBiometric();
                    } catch (error) {
                        console.warn('Biometric setup failed:', error);
                        Utils.showInfo('PIN set, but biometric setup failed');
                    }
                }
                
                // Clear inputs
                document.getElementById('setup-pin').value = '';
                document.getElementById('setup-pin-confirm').value = '';
                document.getElementById('enable-biometric-checkbox').checked = false;
                
                // Hide setup modal
                document.getElementById('security-setup-modal').classList.add('hidden');
                
                // Unlock the app
                window.Security.isUnlocked = true;
                
                Loading.hide();
                Utils.showSuccess('ðŸ”’ PIN enabled successfully!');
                
                // Show master password setup next
                setTimeout(() => {
                    showMasterPasswordSetup();
                }, 500);
                
            } catch (error) {
                Loading.hide();
                console.error('Security setup error:', error);
                Utils.showError(error.message || 'Failed to setup security');
            }
        }
        
        /**
         * Unlock with PIN
         */
        async function unlockWithPin() {
            try {
                const pin = document.getElementById('unlock-pin').value;
                
                if (!pin) {
                    Utils.showError('Please enter your PIN');
                    return;
                }
                
                Loading.show('Verifying PIN...');
                
                const success = await window.Security.unlockWithPin(pin);
                
                Loading.hide();
                
                if (success) {
                    // Clear input
                    document.getElementById('unlock-pin').value = '';
                    
                    // Hide unlock modal
                    document.getElementById('security-unlock-modal').classList.add('hidden');
                    
                    // Update auth timestamp for credentials page grace period
                    if (window.Navigation) {
                        window.Navigation.updateAuthTimestamp();
                    }
                    
                    // Continue app initialization (no toast - just unlock silently)
                    window.App.init();
                } else {
                    Utils.showError('âŒ Incorrect PIN');
                    // Shake animation
                    const input = document.getElementById('unlock-pin');
                    input.classList.add('shake');
                    setTimeout(() => input.classList.remove('shake'), 500);
                }
            } catch (error) {
                Loading.hide();
                console.error('Unlock error:', error);
                Utils.showError('Failed to unlock');
            }
        }
        
        /**
         * Unlock with biometric
         */
        async function unlockWithBiometric() {
            try {
                console.log('ðŸ” Starting biometric unlock...');
                Loading.show('Authenticating...');
                
                const success = await window.Security.authenticateWithBiometric();
                console.log('ðŸ” Biometric authentication result:', success);
                
                Loading.hide();
                
                if (success) {
                    // Hide unlock modal
                    document.getElementById('security-unlock-modal').classList.add('hidden');
                    
                    // Update auth timestamp for credentials page grace period
                    if (window.Navigation) {
                        window.Navigation.updateAuthTimestamp();
                    }
                    
                    // Continue app initialization (no toast - just unlock silently)
                    window.App.init();
                }
            } catch (error) {
                Loading.hide();
                console.error('âŒ Biometric unlock error:', error);
                console.error('Error type:', error.constructor.name);
                console.error('Error message:', error.message);
                console.error('Error code:', error.code);
                console.error('Full error object:', JSON.stringify(error, null, 2));
                
                if (error.message && error.message.includes('cancelled')) {
                    Utils.showInfo('Biometric cancelled. Use PIN instead.');
                } else {
                    Utils.showError(`Biometric failed: ${error.message || error.code || 'Unknown error'}. Use PIN instead.`);
                }
            }
        }
        
        /**
         * Show Master Password Setup (Onboarding Step 2)
         */
        function showMasterPasswordSetup() {
            document.getElementById('master-password-setup-modal').classList.remove('hidden');
        }
        
        /**
         * Complete Master Password Setup
         */
        function completeMasterPasswordSetup() {
            const password = document.getElementById('onboarding-master-password').value.trim();
            const confirmPassword = document.getElementById('onboarding-master-password-confirm').value.trim();
            
            if (!password) {
                Utils.showError('âš ï¸ Master password is required!\n\nThis password encrypts your backups.');
                return;
            }
            
            if (password.length < 6) {
                Utils.showError('âš ï¸ Master password must be at least 6 characters long');
                return;
            }
            
            if (password !== confirmPassword) {
                Utils.showError('âŒ Passwords do not match');
                return;
            }
            
            // Save master password
            window.DB.security.masterPassword = password;
            window.Storage.save();
            
            // Hide modal
            document.getElementById('master-password-setup-modal').classList.add('hidden');
            
            Utils.showSuccess('ðŸ” Master password set successfully!');
            
            // Show AI Keys setup next
            setTimeout(() => {
                showAIKeysSetup();
            }, 500);
        }
        
        /**
         * Show AI Keys Setup (Onboarding Step 3)
         */
        function showAIKeysSetup() {
            document.getElementById('ai-keys-setup-modal').classList.remove('hidden');
        }
        
        /**
         * Complete AI Keys Setup
         */
        function completeAIKeysSetup() {
            const geminiKey = document.getElementById('onboarding-gemini-key').value.trim();
            const groqKey = document.getElementById('onboarding-groq-key').value.trim();
            const chatgptKey = document.getElementById('onboarding-chatgpt-key').value.trim();
            const perplexityKey = document.getElementById('onboarding-perplexity-key').value.trim();
            
            // Check if at least ONE AI key is provided
            if (!geminiKey && !groqKey && !chatgptKey && !perplexityKey) {
                Utils.showError('âš ï¸ At least ONE AI API key is required!\n\nChoose any:\nâ€¢ Gemini (recommended)\nâ€¢ Groq (fastest chat)\nâ€¢ ChatGPT\nâ€¢ Perplexity');
                return;
            }
            
            // IMPORTANT: Check for web search capability (needed for card benefits)
            if (!geminiKey && !perplexityKey) {
                Utils.showError('âš ï¸ Warning: Card Benefits feature requires web search!\n\nYou need at least ONE of:\nâ€¢ Gemini (recommended)\nâ€¢ Perplexity\n\nGroq/ChatGPT alone will work for chat, but NOT for fetching card benefits.');
                return;
            }
            
            // Save API keys
            window.DB.settings.geminiApiKey = geminiKey;
            window.DB.groqApiKey = groqKey;
            window.DB.settings.groqApiKey = groqKey;
            window.DB.settings.chatGptApiKey = chatgptKey;
            window.DB.settings.perplexityApiKey = perplexityKey;
            window.Storage.save();
            
            // Hide modal
            document.getElementById('ai-keys-setup-modal').classList.add('hidden');
            
            Utils.showSuccess('âœ… Setup complete! Welcome to My Assistant!');
            
            // Start the app
            setTimeout(() => {
                window.App.init();
            }, 1000);
        }
        
        // Make security functions globally accessible
        window.setupSecurity = setupSecurity;
        window.unlockWithPin = unlockWithPin;
        window.unlockWithBiometric = unlockWithBiometric;
        window.checkBiometricAvailability = checkBiometricAvailability;
        window.openChangePinModal = openChangePinModal;
        window.closeChangePinModal = closeChangePinModal;
        window.changePin = changePin;
        window.showMasterPasswordSetup = showMasterPasswordSetup;
        window.completeMasterPasswordSetup = completeMasterPasswordSetup;
        window.showAIKeysSetup = showAIKeysSetup;
        window.completeAIKeysSetup = completeAIKeysSetup;
    </script>
</body>
</html>




